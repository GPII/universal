/*!
GPII MatchMaker Utilities Tests

Copyright 2014 Raising The Floor - International

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

The research leading to these results has received funding from the European Union's
Seventh Framework Programme (FP7/2007-2013) under grant agreement no. 289016.

You may obtain a copy of the License at
https://github.com/GPII/universal/blob/master/LICENSE.txt
*/

/*global jqUnit */

var fluid = fluid || require("infusion"),
    gpii = fluid.registerNamespace("gpii"),
    $ = fluid.registerNamespace("jQuery");

(function () {
    "use strict";
    fluid.registerNamespace("gpii.tests.matchMakerUtilities");

    var transformSpec = $.ajax({
        type: "GET",
        url: "../../../../../testData/ontologies/ISO24751-flat.json",
        async: false,
        dataType: "json"
    }).responseJSON;

    var apptologyTransformSpec = $.ajax({
        type: "GET",
        url: "../../../../../testData/ontologies/flat-apptology.json",
        async: false,
        dataType: "json"
    }).responseJSON;

    var containsSameValueSpecs = [{
        description: "No matching values",
        arr1: [ "a", "x" ],
        arr2: [ "b", "c" ],
        expected: false
    }, {
        description: "Single matching value",
        arr1: [ "a", "x" ],
        arr2: [ "b", "x", "c" ],
        expected: true
    }, {
        description: "Multiple matching values",
        arr1: [ "a", "x", "y" ],
        arr2: [ "x", "b", "y" ],
        expected: true
    }, {
        description: "single entry - matching",
        arr1: [ "x" ],
        arr2: [ "x" ],
        expected: true
    }, {
        description: "one array is empty",
        arr1: [ "a" ],
        arr2: [ ],
        expected: false
    }, {
        description: "other array is empty",
        arr1: [ ],
        arr2: [ "b", "b1" ],
        expected: false
    }];

    gpii.tests.matchMakerUtilities.containsSameValue = function () {
        fluid.each(containsSameValueSpecs, function (spec) {
            var result = gpii.matchMakerFramework.utils.containsSameValue(spec.arr1, spec.arr2);
            jqUnit.assertDeepEq(spec.name, spec.expected, result);
        });
    };

    var computeLeavesFixtures = [
        {
            description: "Nested structure including empty objects",
            model: {
                "display": {
                    "screenEnhancement": {
                        "fontSize": 24,
                        "foregroundColor": "white",
                        "backgroundColor": "black",
                        "fontFace": {
                            "genericFontFace": "sans serif"
                        },
                        "screenMagnification": {
                        }
                    }
                },
                "control": {
                    "structuralNavigation": {
                        "tableOfContents": false
                    }
                }
            },
            expected: [
                "display.screenEnhancement.fontSize",
                "display.screenEnhancement.foregroundColor",
                "display.screenEnhancement.backgroundColor",
                "display.screenEnhancement.fontFace.genericFontFace",
                "control.structuralNavigation.tableOfContents"
            ]
        }
    ];

    gpii.tests.matchMakerUtilities.computeLeaves = function () {
        fluid.each(computeLeavesFixtures, function (fixture) {
            var result = gpii.matchMakerFramework.utils.computeLeaves(fixture.model);
            jqUnit.assertDeepEq(fixture.name, fixture.expected, result);
        });
    };

    var pathsToSkeletonFixtures = [
        {
            description: "Object with various levels of nesting",
            expected: {
                "display": {
                    "screenEnhancement": {
                        "fontSize": {},
                        "foregroundColor": {},
                        "backgroundColor": {},
                        "fontFace": {
                            "genericFontFace": {}
                        }
                    },
                    "hello": {}
                },
                "control": {
                    "structuralNavigation": {
                        "tableOfContents": {}
                    }
                },
                "cat": {}
            },
            model: [
                "display.screenEnhancement.fontSize",
                "display.screenEnhancement.foregroundColor",
                "display.screenEnhancement.backgroundColor",
                "display.screenEnhancement.fontFace.genericFontFace",
                "display.hello",
                "control.structuralNavigation.tableOfContents",
                "cat"
            ]
        }, {
            description: "Object with various levels of nesting",
            expected: {
                "display": {
                    "screenEnhancement": {
                        "fontSize": true,
                        "foregroundColor": true,
                        "backgroundColor": true,
                        "fontFace": {
                            "genericFontFace": true
                        }
                    },
                    "hello": true
                },
                "control": {
                    "structuralNavigation": {
                        "tableOfContents": true
                    }
                },
                "cat": true
            },
            model: [
                "display.screenEnhancement.fontSize",
                "display.screenEnhancement.foregroundColor",
                "display.screenEnhancement.backgroundColor",
                "display.screenEnhancement.fontFace.genericFontFace",
                "display.hello",
                "control.structuralNavigation.tableOfContents",
                "cat"
            ],
            value: true
        }
    ];

    gpii.tests.matchMakerUtilities.pathsToSkeleton = function () {
        fluid.each(pathsToSkeletonFixtures, function (fixture) {
            var result = gpii.matchMakerFramework.utils.pathsToSkeleton(fixture.model, fixture.value);
            jqUnit.assertDeepEq(fixture.name, fixture.expected, result);
        });
    };

    var computeAndOntologizeCapabilitiesFromSolutionFixture = {
        description: "solution incl capabilities and transformations",
        model: {
            "name": "GNOME Shell Magnifier",
            "contexts": {},
            "settingsHandlers": {
                "configuration": {
                    "type": "gpii.gsettings",
                    "options": {
                        "schema": "org.gnome.desktop.a11y.magnifier"
                    },
                    "capabilities": [
                        "http://registry\\.gpii\\.net/common/invertColours"
                    ],
                    "capabilitiesTransformations": {
                        "mag-factor": "http://registry\\.gpii\\.net/common/magnification",
                        "show-cross-hairs": "http://registry\\.gpii\\.net/common/showCrosshairs",
                        "transform": {
                            "type": "fluid.transforms.arrayToSetMembership",
                            "inputPath": "http://registry\\.gpii\\.net/common/tracking",
                            "presentValue": "proportional",
                            "missingValue": "none",
                            "options": {
                                "focus": "focus-tracking",
                                "caret": "caret-tracking",
                                "mouse": "mouse-tracking"
                            }
                        },
                        "screen-position": {
                            "transform": {
                                "type": "fluid.transforms.valueMapper",
                                "defaultInputPath": "http://registry\\.gpii\\.net/common/magnifierPosition",
                                "match": {
                                    "FullScreen": "full-screen",
                                    "Lens": "full-screen",
                                    "LeftHalf": "left-half",
                                    "RightHalf": "right-half",
                                    "TopHalf": "top-half",
                                    "BottomHalf": "bottom-half"
                                },
                                "noMatch": {
                                    "outputValue": "full-screen"
                                }
                            }
                        }
                    }
                }
            },
            "update": [
                "settings.configuration"
            ],
            "configure": [
                "settings.configuration"
            ],
            "restore": [
                "settings.configuration"
            ],
            "start": [
                {
                    "type": "gpii.launch.exec",
                    "command": "gsettings set org.gnome.desktop.a11y.applications screen-magnifier-enabled true"
                }
            ],
            "stop": [
                {
                    "type": "gpii.launch.exec",
                    "command": "gsettings set org.gnome.desktop.a11y.applications screen-magnifier-enabled false"
                }
            ],
            "isInstalled": [
                {
                    "type": "gpii.packageKit.find",
                    "name": "gnome-shell"
                }
            ]
        },
        expectedISO: [
            "display.screenEnhancement.tracking",
            "display.screenEnhancement.magnification",
            "display.screenEnhancement.-provisional-invertColours",
            "display.screenEnhancement.-provisional-magnifierPosition"
        ],
        expectedApptology: [
            "http://registry\\.gpii\\.net/common/magnifierApplication"
        ]
    };

    gpii.tests.matchMakerUtilities.computeAndOntologizeCapabilitiesFromSolution = function () {
        var fixture = computeAndOntologizeCapabilitiesFromSolutionFixture;
        var flatToISOSpec = fluid.model.transform.invertConfiguration(transformSpec);

        var resultISO = gpii.matchMakerFramework.utils.computeAndOntologizeCapabilitiesFromSolution(fixture.model, flatToISOSpec);
        jqUnit.assertDeepEq(fixture.description, fixture.expectedISO, resultISO);

        var resultApptology = gpii.matchMakerFramework.utils.computeAndOntologizeCapabilitiesFromSolution(fixture.model, apptologyTransformSpec);
        jqUnit.assertDeepEq(fixture.description, fixture.expectedApptology, resultApptology);
    };

    var buildReturnPayloadFixtures = [
        {
            description: "Basic payloads",
            disposed: {
                "gpii-default": [
                    "mac.dummy"
                ]
            },
            fullModel: {
                "userToken": "mac",
                "preferences": {
                    "contexts": {
                        "gpii-default": {
                            "name": "Default preferences",
                            "preferences": {
                                "http://registry.gpii.net/common/fontSize": 16,
                                "http://registry.gpii.net/common/screenReaderTTSEnabled": false,
                                "http://registry.gpii.net/common/magnifierEnabled": false,
                                "http://registry.gpii.net/common/magnification": 1
                            }
                        }
                    }
                },
                "deviceReporter": {
                    "solutions": [
                        {
                            "id": "mac.dummy"
                        },
                        {
                            "id": "mac.dummy_empty"
                        }
                    ],
                    "OS": {
                        "id": "darwin",
                        "version": "12.5.0"
                    }
                },
                "solutionsRegistry": {
                    "mac.dummy": {
                        "name": "Mac dummy",
                        "contexts": {
                            "OS": [
                                {
                                    "id": "darwin"
                                }
                            ]
                        },
                        "settingsHandlers": {
                            "myconf": {
                                "type": "gpii.settingsHandlers.JSONSettingsHandler.set",
                                "options": {
                                    "path": "/path/to/some/file.json"
                                },
                                "capabilities": [],
                                "capabilitiesTransformations": {
                                    "setting1": "http://registry\\.gpii\\.net/common/fontSize",
                                    "setting2.path1": "http://registry\\.gpii\\.net/common/screenReaderTTSEnabled",
                                    "setting2.path2": "http://registry\\.gpii\\.net/common/magnifierEnabled",
                                    "setting2.path3.hello": "http://registry\\.gpii\\.net/common/magnification"
                                }
                            }
                        },
                        "configure": [
                            "settings.myconf"
                        ],
                        "restore": [
                            "settings.myconf"
                        ]
                    },
                    "mac.dummy_empty": {
                        "name": "Mac dummy empty",
                        "contexts": {
                            "OS": [
                                {
                                    "id": "darwin"
                                }
                            ]
                        },
                        "settingsHandlers": {
                            "otherconf": {
                                "type": "gpii.settingsHandlers.noSettings",
                                "capabilities": []
                            }
                        },
                        "start": [],
                        "stop": []
                    }
                },
                "activeContexts": [
                    "gpii-default"
                ],
                "environmentReporter": {},
                "inferredCommonTerms": {
                    "gpii-default": {}
                },
                "hierarchicalPrefs": {
                    "contexts": {
                        "gpii-default": {
                            "name": "Default preferences",
                            "preferences": {
                                "display": {
                                    "screenEnhancement": {
                                        "fontSize": 16,
                                        "magnification": 1,
                                        "-provisional-magnifierEnabled": false
                                    },
                                    "screenReader": {
                                        "-provisional-screenReaderTTSEnabled": false
                                    }
                                }
                            }
                        }
                    }
                }
            },
            expected: {
                "inferredConfiguration": {
                    "gpii-default": {
                        "applications": {
                            "mac.dummy": {
                                "active": true,
                                "settings": {
                                    "http://registry.gpii.net/common/fontSize": 16,
                                    "http://registry.gpii.net/common/screenReaderTTSEnabled": false,
                                    "http://registry.gpii.net/common/magnifierEnabled": false,
                                    "http://registry.gpii.net/common/magnification": 1
                                }
                            }
                        }
                    }
                }
            }
        }
    ];

    gpii.tests.matchMakerUtilities.buildReturnPayload = function () {
        fluid.each(buildReturnPayloadFixtures, function (fixture) {
            var result = gpii.matchMakerFramework.utils.buildReturnPayload(fixture.fullModel, fixture.disposed);
            jqUnit.assertDeepEq(fixture.description, fixture.expected, result);
        });
    };


    var inferredCommonfixtures = [
        {
            name: "No existing prefs in original set",
            preferences: {
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {}
                    }
                }
            },
            inferred: {
                "gpii-default": {
                    "org.gnome.desktop.interface": {
                        "http://registry.gpii.net/common/fontSize": 9,
                        "http://registry.gpii.net/common/cursorSize": 0.9
                    },
                    "org.gnome.desktop.a11y.magnifier": {
                        "http://registry.gpii.net/common/magnification": 1.5,
                        "http://registry.gpii.net/common/magnifierPosition": "FullScreen"
                    }
                }
            },
            expect: {
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "http://registry.gpii.net/common/fontSize": 9,
                            "http://registry.gpii.net/common/cursorSize": 0.9,
                            "http://registry.gpii.net/common/magnification": 1.5,
                            "http://registry.gpii.net/common/magnifierPosition": "FullScreen"
                        }
                    }
                }
            }
        }, {
            name: "Existing prefs in original set, some being overwritten",
            preferences: {
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "http://registry.gpii.net/applications/org.gnome.desktop.interface": {
                                "cursor-size": 90,
                                "text-scaling-factor": 0.75
                            },
                            "http://registry.gpii.net/applications/org.alsa-project": {
                                "masterVolume": 50
                            },
                            "http://registry.gpii.net/common/cursorSize": 1
                        }
                    }
                }
            },
            inferred: {
                "gpii-default": {
                    "org.gnome.desktop.interface": {
                        "http://registry.gpii.net/common/fontSize": 9,
                        "http://registry.gpii.net/common/cursorSize": 0.9
                    },
                    "org.gnome.desktop.a11y.magnifier": {
                        "http://registry.gpii.net/common/magnification": 1.5,
                        "http://registry.gpii.net/common/magnifierPosition": "FullScreen"
                    }
                }
            },
            expect: {
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "http://registry.gpii.net/applications/org.gnome.desktop.interface": {
                                "cursor-size": 90,
                                "text-scaling-factor": 0.75
                            },
                            "http://registry.gpii.net/applications/org.alsa-project": {
                                "masterVolume": 50
                            },
                            "http://registry.gpii.net/common/fontSize": 9,
                            "http://registry.gpii.net/common/cursorSize": 1,
                            "http://registry.gpii.net/common/magnification": 1.5,
                            "http://registry.gpii.net/common/magnifierPosition": "FullScreen"
                        }
                    }
                }
            }
        }, {
            name: "Two instances of the same common term present in the inferred common terms",
            preferences: {
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "http://registry.gpii.net/common/cursorSize": 1
                        }
                    }
                }
            },
            inferred: {
                "gpii-default": {
                    "org.gnome.desktop.interface": {
                        "http://registry.gpii.net/common/fontSize": 9,
                        "http://registry.gpii.net/common/cursorSize": 0.9
                    },
                    "org.gnome.desktop.a11y.magnifier": {
                        "http://registry.gpii.net/common/fontSize": 1.5,
                        "http://registry.gpii.net/common/magnifierPosition": "FullScreen"
                    }
                }
            },
            expect: {
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "http://registry.gpii.net/common/fontSize": 9,
                            "http://registry.gpii.net/common/cursorSize": 1,
                            "http://registry.gpii.net/common/magnifierPosition": "FullScreen"
                        }
                    }
                }
            }
        }
    ];

    gpii.tests.matchMakerUtilities.testaddInferredCommonTerms = function () {
        jqUnit.module("Inferred common terms merging");
        fluid.each(inferredCommonfixtures, function (fixture) {
            var result = gpii.matchMakerFramework.utils.addInferredCommonTerms(fixture.preferences, fixture.inferred);
            jqUnit.assertDeepEq(fixture.name, fixture.expect, result);
        });
    };

    var addSolutionTypeInformationFixtures = [{
        name: "Three solutions, two of same type",
        payload: {
            solutionsRegistryEntries: {
                "fakemag1": {
                    "name": "Fake Magnifier 1",
                    "contexts": {
                        "OS": [
                            {
                                "id": "darwin"
                            }
                        ]
                    },
                    "settingsHandlers": {
                        "configuration": {
                            "type": "gpii.settingsHandlers.JSONSettingsHandler",
                            "options": {
                                "filename": "/tmp/fakemag1.settings.json"
                            },
                            "capabilities": [
                                "http://registry\\.gpii\\.net/common/magnifierEnabled"
                            ],
                            "capabilitiesTransformations": {
                                "magnification": "http://registry\\.gpii\\.net/common/magnification"
                            }
                        }
                    },
                    "configure": [
                        "settings.configuration"
                    ],
                    "restore": [
                        "settings.configuration"
                    ],
                    "start": [],
                    "stop": [],
                    "isInstalled": [
                        {
                            "type": "gpii.deviceReporter.alwaysInstalled"
                        }
                    ]
                },
                "fakemag2": {
                    "name": "Fake Magnifier 2 - fully featured",
                    "contexts": {
                        "OS": [
                            {
                                "id": "darwin"
                            }
                        ]
                    },
                    "settingsHandlers": {
                        "configuration": {
                            "type": "gpii.settingsHandlers.JSONSettingsHandler",
                            "options": {
                                "filename": "/tmp/fakemag2.settings.json"
                            },
                            "capabilities": [
                                "http://registry\\.gpii\\.net/common/magnifierEnabled"
                            ],
                            "capabilitiesTransformations": {
                                "magnification": "http://registry\\.gpii\\.net/common/magnification",
                                "invert": "http://registry\\.gpii\\.net/common/invertColours"
                            }
                        }
                    },
                    "configure": [
                        "settings.configuration"
                    ],
                    "restore": [
                        "settings.configuration"
                    ],
                    "start": [],
                    "stop": [],
                    "isInstalled": [
                        {
                            "type": "gpii.deviceReporter.alwaysInstalled"
                        }
                    ]
                },
                "fakescreenreader1": {
                    "name": "fake screenreader",
                    "contexts": {
                        "OS": [
                            {
                                "id": "darwin"
                            }
                        ]
                    },
                    "settingsHandlers": {
                        "configuration": {
                            "type": "gpii.settingsHandlers.JSONSettingsHandler",
                            "options": {
                                "filename": "/tmp/fakescreenreader1.json"
                            },
                            "capabilities": [
                                "http://registry\\.gpii\\.net/common/screenReaderTTSEnabled"
                            ],
                            "capabilitiesTransformations": {
                                "pitch": "http://registry\\.gpii\\.net/common/pitch",
                                "volumeTTS": "http://registry\\.gpii\\.net/common/volumeTTS",
                                "rate": "http://registry\\.gpii\\.net/common/speechRate"
                            }
                        }
                    },
                    "configure": [
                        "settings.configuration"
                    ],
                    "restore": [
                        "settings.configuration"
                    ],
                    "start": [],
                    "stop": [],
                    "isInstalled": [
                        {
                            "type": "gpii.deviceReporter.alwaysInstalled"
                        }
                    ]
                }
            }
        },
        expectedSolutionTypes: {
            "fakemag1": [
                "http://registry\\.gpii\\.net/common/magnifierApplication"
            ],
            "fakemag2": [
                "http://registry\\.gpii\\.net/common/magnifierApplication"
            ],
            "fakescreenreader1": [
                "http://registry\\.gpii\\.net/common/screenReaderApplication"
            ]
        },
        expectedSolutionTypeMapping: {
            "http://registry\\.gpii\\.net/common/magnifierApplication": {
                "fakemag1": true,
                "fakemag2": true
            },
            "http://registry\\.gpii\\.net/common/screenReaderApplication": {
                "fakescreenreader1": true
            }
        }
    }];

    gpii.tests.matchMakerUtilities.testAddSolutionTypeInformation = function () {
        jqUnit.module("AddSolutionTypeInformation tests");
        fluid.each(addSolutionTypeInformationFixtures, function (fixture) {
            var payload = fluid.copy(fixture.payload);
            gpii.matchMakerFramework.utils.addSolutionTypeInformation(payload, apptologyTransformSpec);
            jqUnit.assertDeepEq(fixture.name + ". Checking solutions types are properly added", fixture.expectedSolutionTypes, payload.solutionTypes);
            jqUnit.assertDeepEq(fixture.name + ". Checking solutions Mapping is properly added", fixture.expectedSolutionTypeMapping, payload.solutionTypeMapping);
        });
    };


    gpii.tests.matchMakerUtilities.runTests = function () {
        jqUnit.module("MatchMakerUtilities");
        jqUnit.test("Contains same value", gpii.tests.matchMakerUtilities.containsSameValue);
        jqUnit.test("Compute Leaves", gpii.tests.matchMakerUtilities.computeLeaves);
        jqUnit.test("Paths to Skeleton", gpii.tests.matchMakerUtilities.pathsToSkeleton);
        jqUnit.test("Compute Capabilities From Solution", gpii.tests.matchMakerUtilities.computeAndOntologizeCapabilitiesFromSolution);
        jqUnit.test("Build Return Payload", gpii.tests.matchMakerUtilities.buildReturnPayload);
        jqUnit.test("Merging inferred common terms with preferences", gpii.tests.matchMakerUtilities.testaddInferredCommonTerms);
        jqUnit.test("Adding solution type information to payload", gpii.tests.matchMakerUtilities.testAddSolutionTypeInformation);
    };

})();
