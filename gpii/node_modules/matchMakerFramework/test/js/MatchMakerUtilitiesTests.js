/*!
GPII MatchMaker Utilities Tests

Copyright 2014 Raising The Floor - International

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

You may obtain a copy of the License at
https://github.com/gpii/universal/LICENSE.txt
*/

/*global jqUnit */

var fluid = fluid || require("infusion");
var gpii = fluid.registerNamespace("gpii");

(function () {
    "use strict";
    fluid.registerNamespace("gpii.tests.matchMakerUtilities");

    var transformSpec = {
        "http://registry\\.gpii\\.net/common/fontSize": "display.screenEnhancement.fontSize",
        "http://registry\\.gpii\\.net/common/foregroundColor": "display.screenEnhancement.foregroundColor",
        "http://registry\\.gpii\\.net/common/backgroundColor": "display.screenEnhancement.backgroundColor",
        "http://registry\\.gpii\\.net/common/fontFaceFontName": "display.screenEnhancement.fontFaceFontName",
        "http://registry\\.gpii\\.net/common/fontFaceGenericFontFace": "display.screenEnhancement.fontFaceGenericFontFace",
        "http://registry\\.gpii\\.net/common/magnifierEnabled": "display.screenEnhancement.-provisional-magnifierEnabled",
        "http://registry\\.gpii\\.net/common/magnification": "display.screenEnhancement.magnification",
        "http://registry\\.gpii\\.net/common/magnifierPosition": "display.screenEnhancement.-provisional-magnifierPosition",
        "http://registry\\.gpii\\.net/common/tracking": "display.screenEnhancement.tracking",
        "http://registry\\.gpii\\.net/common/trackingTTS": "display.screenEnhancement.trackingTTS",
        "http://registry\\.gpii\\.net/common/invertImages": "display.screenEnhancement.invertImages",
        "http://registry\\.gpii\\.net/common/invertColours": "display.screenEnhancement.-provisional-invertColours",
        "http://registry\\.gpii\\.net/common/cursorSize": "display.screenEnhancement.cursorSize",
        "http://registry\\.gpii\\.net/common/highContrastEnabled": "display.screenEnhancement.-provisional-highContrastEnabled",
        "http://registry\\.gpii\\.net/common/highContrastTheme": "display.screenEnhancement.-provisional-highContrastTheme",
        "http://registry\\.gpii\\.net/common/mouseTrailing": "display.screenEnhancement.mouseTrailing",
        "http://registry\\.gpii\\.net/common/screenReaderBrailleOutput": "display.screenReader.-provisional-screenReaderBrailleOutput",
        "http://registry\\.gpii\\.net/common/auditoryOutLanguage": "display.screenReader.-provisional-auditoryOutLanguage",
        "http://registry\\.gpii\\.net/common/speechRate": "display.screenReader.speechRate",
        "http://registry\\.gpii\\.net/common/speakTutorialMessages": "display.screenReader.-provisional-speakTutorialMessages",
        "http://registry\\.gpii\\.net/common/keyEcho": "display.screenReader.-provisional-keyEcho",
        "http://registry\\.gpii\\.net/common/wordEcho": "display.screenReader.-provisional-wordEcho",
        "http://registry\\.gpii\\.net/common/announceCapitals": "display.screenReader.-provisional-announceCapitals",
        "http://registry\\.gpii\\.net/common/punctuationVerbosity": "display.screenReader.-provisional-punctuationVerbosity",
        "http://registry\\.gpii\\.net/common/screenReaderTTSEnabled": "display.screenReader.-provisional-screenReaderTTSEnabled",
        "http://registry\\.gpii\\.net/common/pitch": "display.textReadingHighlight.pitch",
        "http://registry\\.gpii\\.net/common/readingUnit": "display.textReadingHighlight.readingUnit",
        "http://registry\\.gpii\\.net/common/volumeTTS": "display.textReadingHighlight.-provisional-volumeTTS",
        "http://registry\\.gpii\\.net/common/selfVoicingEnabled": "display.textReadingHighlight.-provisional-selfVoicingEnabled",
        "http://registry\\.gpii\\.net/common/brailleMode": "display.braille.-provisional-brailleMode",
        "http://registry\\.gpii\\.net/common/screenOffTime": "display.-provisional-screenOffTime",
        "http://registry\\.gpii\\.net/common/screenRotation": "display.-provisional-screenRotation",
        "http://registry\\.gpii\\.net/common/screenDefaultRotation": "display.-provisional-screenDefaultRotation",
        "http://registry\\.gpii\\.net/common/screenDim": "display.-provisional-screenDim",
        "http://registry\\.gpii\\.net/common/onscreenKeyboard": "control.onscreenKeyboard",
        "http://registry\\.gpii\\.net/common/initDelay": "control.mouseEmulation.-provisional-initDelay",
        "http://registry\\.gpii\\.net/common/cursorSpeed": "control.mouseEmulation.cursorSpeed",
        "http://registry\\.gpii\\.net/common/cursorAcceleration": "control.mouseEmulation.cursorAcceleration",
        "http://registry\\.gpii\\.net/common/mouseEmulationEnabled": "control.mouseEmulation.-provisional-mouseEmulationEnabled",
        "http://registry\\.gpii\\.net/common/stickyKeys": "control.keyboardEnhancement.stickyKeys",
        "http://registry\\.gpii\\.net/common/slowKeysInterval": "control.keyboardEnhancement.slowKeys.slowKeysInterval",
        "http://registry\\.gpii\\.net/common/slowKeysEnable": "control.keyboardEnhancement.slowKeys.-provisional-slowKeysEnable",
        "http://registry\\.gpii\\.net/common/debounceEnable": "control.keyboardEnhancement.debounceKeys.-provisional-debounceEnable",
        "http://registry\\.gpii\\.net/common/debounceInterval": "control.keyboardEnhancement.debounceKeys.debounceInterval",
        "http://registry\\.gpii\\.net/common/hapticFeedback": "control.-provisional-hapticFeedback",
        "http://registry\\.gpii\\.net/common/adaptationPreference": "content.adaptationPreference",
        "http://registry\\.gpii\\.net/common/showCrosshairs": "display.screenEnhancement.showCrosshairs",
        "http://registry\\.gpii\\.net/common/tableOfContents": "control.structuralNavigation.tableOfContents",
        "http://registry\\.gpii\\.net/common/volume": "-provisional-general.-provisional-volume",
        "http://registry\\.gpii\\.net/common/language": "language",
        "": {
            "transform": {
                "type": "gpii.ontologyHandler.transforms.applicationISOToFlat",
                "inputPath": "applications",
                "outputPath": ""
            }
        }
    };

    var computeLeavesFixtures = [
        {
            description: "Nested structure including empty objects",
            model: {
                "display": {
                    "screenEnhancement": {
                        "fontSize": 24,
                        "foregroundColor": "white",
                        "backgroundColor": "black",
                        "fontFace": {
                            "genericFontFace": "sans serif"
                        },
                        "screenMagnification": {
                        }
                    }
                },
                "control": {
                    "structuralNavigation": {
                        "tableOfContents": false
                    }
                }
            },
            expected: [
                "display.screenEnhancement.fontSize",
                "display.screenEnhancement.foregroundColor",
                "display.screenEnhancement.backgroundColor",
                "display.screenEnhancement.fontFace.genericFontFace",
                "control.structuralNavigation.tableOfContents"
            ]
        }
    ];

    gpii.tests.matchMakerUtilities.computeLeaves = function () {
        fluid.each(computeLeavesFixtures, function (fixture) {
            var result = gpii.matchMakerFramework.utils.computeLeaves(fixture.model);
            jqUnit.assertDeepEq(fixture.name, fixture.expected, result);
        });
    };

    var pathsToSkeletonFixtures = [
        {
            description: "Object with various levels of nesting",
            expected: {
                "display": {
                    "screenEnhancement": {
                        "fontSize": {},
                        "foregroundColor": {},
                        "backgroundColor": {},
                        "fontFace": {
                            "genericFontFace": {}
                        }
                    },
                    "hello": {}
                },
                "control": {
                    "structuralNavigation": {
                        "tableOfContents": {}
                    }
                },
                "cat": {}
            },
            model: [
                "display.screenEnhancement.fontSize",
                "display.screenEnhancement.foregroundColor",
                "display.screenEnhancement.backgroundColor",
                "display.screenEnhancement.fontFace.genericFontFace",
                "display.hello",
                "control.structuralNavigation.tableOfContents",
                "cat"
            ]
        }, {
            description: "Object with various levels of nesting",
            expected: {
                "display": {
                    "screenEnhancement": {
                        "fontSize": true,
                        "foregroundColor": true,
                        "backgroundColor": true,
                        "fontFace": {
                            "genericFontFace": true
                        }
                    },
                    "hello": true
                },
                "control": {
                    "structuralNavigation": {
                        "tableOfContents": true
                    }
                },
                "cat": true
            },
            model: [
                "display.screenEnhancement.fontSize",
                "display.screenEnhancement.foregroundColor",
                "display.screenEnhancement.backgroundColor",
                "display.screenEnhancement.fontFace.genericFontFace",
                "display.hello",
                "control.structuralNavigation.tableOfContents",
                "cat"
            ],
            value: true
        }
    ];

    gpii.tests.matchMakerUtilities.pathsToSkeleton = function () {
        fluid.each(pathsToSkeletonFixtures, function (fixture) {
            var result = gpii.matchMakerFramework.utils.pathsToSkeleton(fixture.model, fixture.value);
            jqUnit.assertDeepEq(fixture.name, fixture.expected, result);
        });
    };

    var computeCapabilitiesFromSolutionFixtures = [
        {
            description: "solution incl capabilities and transformations",
            model: {
                "settingsHandlers": [
                    {
                        "type": "gpii.gsettings.set",
                        "options": {
                            "schema": "org.gnome.desktop.a11y.magnifier"
                        },
                        "capabilities": [
                            "applications.org\\.gnome\\.desktop\\.a11y\\.magnifier.id",
                            "display.screenEnhancement.screenMagnification.applications.org\\.gnome\\.desktop\\.a11y\\.magnifier.name"
                        ],
                        "capabilitiesTransformations": {
                            "mag-factor": "http://registry\\.gpii\\.net/common/magnification",
                            "show-cross-hairs": "http://registry\\.gpii\\.net/common/showCrosshairs",
                            "mouse-tracking": {
                                "transform": {
                                    "type": "fluid.transforms.valueMapper",
                                    "inputPath": "http://registry\\.gpii\\.net/common/tracking",
                                    "options": {
                                        "mouse": {
                                            "outputValue": "centered"
                                        }
                                    }
                                }
                            },
                            "screen-position": {
                                "transform": {
                                    "type": "fluid.transforms.valueMapper",
                                    "inputPath": "http://registry\\.gpii\\.net/common/magnifierPosition",
                                    "defaultInputValue": "Custom",
                                    "options": {
                                        "FullScreen": {
                                            "outputValue": "full-screen"
                                        },
                                        "Lens": {
                                            "outputValue": "full-screen"
                                        },
                                        "LeftHalf": {
                                            "outputValue": "left-half"
                                        },
                                        "RightHalf": {
                                            "outputValue": "right-half"
                                        },
                                        "TopHalf": {
                                            "outputValue": "top-half"
                                        },
                                        "BottomHalf": {
                                            "outputValue": "bottom-half"
                                        },
                                        "Custom": {
                                            "outputValue": "full-screen"
                                        }
                                    }
                                }
                            }
                        }
                    }
                ]
            },
            expected: [
                "applications.org\\.gnome\\.desktop\\.a11y\\.magnifier.id",
                "display.screenEnhancement.screenMagnification.applications.org\\.gnome\\.desktop\\.a11y\\.magnifier.name",
                "display.screenEnhancement.tracking",
                "display.screenEnhancement.magnification",
                "display.screenEnhancement.showCrosshairs",
                "display.screenEnhancement.-provisional-magnifierPosition"
            ]
        }
    ];

    gpii.tests.matchMakerUtilities.computeCapabilitiesFromSolution = function () {
        var flatToISOSpec = fluid.model.transform.invertConfiguration(transformSpec);
        fluid.each(computeCapabilitiesFromSolutionFixtures, function (fixture) {
            var result = gpii.matchMakerFramework.utils.computeCapabilitiesFromSolution(fixture.model, flatToISOSpec);
            jqUnit.assertDeepEq(fixture.description, fixture.expected, result);
        });
    };

    var buildReturnPayloadFixtures = [
        {
            description: "Basic payloads",
            disposed: {
                "gpii-default": [
                    "mac.dummy"
                ]
            },
            fullModel: {
                "userToken": "mac",
                "preferences": {
                    "contexts": {
                        "gpii-default": {
                            "name": "Default preferences",
                            "preferences": {
                                "http://registry.gpii.net/common/fontSize": 16,
                                "http://registry.gpii.net/common/screenReaderTTSEnabled": false,
                                "http://registry.gpii.net/common/magnifierEnabled": false,
                                "http://registry.gpii.net/common/magnification": 1
                            }
                        }
                    }
                },
                "deviceReporter": {
                    "solutions": [
                        {
                            "id": "mac.dummy"
                        },
                        {
                            "id": "mac.dummy_empty"
                        }
                    ],
                    "OS": {
                        "id": "darwin",
                        "version": "12.5.0"
                    }
                },
                "solutionsRegistry": {
                    "mac.dummy": {
                        "name": "Mac dummy",
                        "contexts": {
                            "OS": [
                                {
                                    "id": "darwin"
                                }
                            ]
                        },
                        "settingsHandlers": [
                            {
                                "type": "gpii.settingsHandlers.JSONSettingsHandler.set",
                                "options": {
                                    "path": "/path/to/some/file.json"
                                },
                                "capabilities": [
                                    "applications.mac\\.dummy.id"
                                ],
                                "capabilitiesTransformations": {
                                    "setting1": "http://registry\\.gpii\\.net/common/fontSize",
                                    "setting2.path1": "http://registry\\.gpii\\.net/common/screenReaderTTSEnabled",
                                    "setting2.path2": "http://registry\\.gpii\\.net/common/magnifierEnabled",
                                    "setting2.path3.hello": "http://registry\\.gpii\\.net/common/magnification"
                                }
                            }
                        ],
                        "lifecycleManager": {
                            "start": [
                                "setSettings"
                            ],
                            "stop": [
                                "restoreSettings"
                            ]
                        }
                    },
                    "mac.dummy_empty": {
                        "name": "Mac dummy empty",
                        "contexts": {
                            "OS": [
                                {
                                    "id": "darwin"
                                }
                            ]
                        },
                        "settingsHandlers": [
                            {
                                "type": "gpii.settingsHandlers.noSettings",
                                "capabilities": [
                                    "applications.mac\\.dummy_empty.id"
                                ]
                            }
                        ],
                        "lifecycleManager": {
                            "start": [],
                            "stop": []
                        }
                    }
                },
                "activeContexts": [
                    "gpii-default"
                ],
                "environmentReporter": {},
                "inferredCommonTerms": {
                    "gpii-default": {}
                },
                "hierarchicalPrefs": {
                    "contexts": {
                        "gpii-default": {
                            "name": "Default preferences",
                            "preferences": {
                                "display": {
                                    "screenEnhancement": {
                                        "fontSize": 16,
                                        "magnification": 1,
                                        "-provisional-magnifierEnabled": false
                                    },
                                    "screenReader": {
                                        "-provisional-screenReaderTTSEnabled": false
                                    }
                                }
                            }
                        }
                    }
                }
            },
            expected: {
                "inferredConfiguration": {
                    "gpii-default": {
                        "applications": {
                            "mac.dummy": {
                                "active": true,
                                "settings": {
                                    "http://registry.gpii.net/common/fontSize": 16,
                                    "http://registry.gpii.net/common/screenReaderTTSEnabled": false,
                                    "http://registry.gpii.net/common/magnifierEnabled": false,
                                    "http://registry.gpii.net/common/magnification": 1
                                }
                            }
                        }
                    }
                }
            }
        }
    ];

    gpii.tests.matchMakerUtilities.buildReturnPayload = function () {
        fluid.each(buildReturnPayloadFixtures, function (fixture) {
            var result = gpii.matchMakerFramework.utils.buildReturnPayload(fixture.fullModel, fixture.disposed);
            jqUnit.assertDeepEq(fixture.description, fixture.expected, result);
        });
    };

    gpii.tests.matchMakerUtilities.runTests = function () {
        jqUnit.module("MatchMakerUtilities");
        jqUnit.test("Compute Leaves", gpii.tests.matchMakerUtilities.computeLeaves);
        jqUnit.test("Paths to Skeleton", gpii.tests.matchMakerUtilities.pathsToSkeleton);
        jqUnit.test("Compute Capabilities From Solution", gpii.tests.matchMakerUtilities.computeCapabilitiesFromSolution);
        jqUnit.test("Build Return Payload", gpii.tests.matchMakerUtilities.buildReturnPayload);
    };
}());