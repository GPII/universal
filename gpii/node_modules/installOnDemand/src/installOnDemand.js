/*
 * Install on Demand.
 *
 * Copyright 2018 Raising the Floor - International
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * The R&D leading to these results received funding from the
 * Department of Education - Grant H421A150005 (GPII-APCP). However,
 * these results do not necessarily represent the policy of the
 * Department of Education, and you should not assume endorsement by the
 * Federal Government.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";

var fluid = require("infusion");

var path = require("path"),
    os = require("os"),
    fs = require("fs");

var gpii = fluid.registerNamespace("gpii");
fluid.registerNamespace("gpii.iod");

require("./packageInstaller.js");

fluid.defaults("gpii.iod", {
    gradeNames: ["fluid.component"],
    contextAwareness: {
        platform: {
            checks: {
                windows: {
                    contextValue: "{gpii.contexts.windows}",
                    gradeNames: ["gpii.windows.iod"]
                }
            }
        }
    },
    components: {
        "packageDataSource": {
            type: "kettle.dataSource.file",
            options: {
                gradeNames: "kettle.dataSource.file.moduleTerms",
                path: "%gpii-universal/testData/installOnDemand/%packageName.json",
                termMap: {
                    packageName: "%packageName"
                }
            }
        }
    },
    invokers: {
        requirePackage: {
            funcName: "gpii.iod.requirePackage",
            args: ["{that}", "{arguments}.0"]
        },
        getPackageInfo: {
            funcName: "gpii.iod.getPackageInfo",
            args: ["{that}", "{arguments}.0"]
        },
        startRemoval: {
            funcName: "gpii.iod.startRemoval",
            args: ["{that}", "{arguments}.0"]
        },
        getInstaller: {
            funcName: "gpii.iod.getInstaller",
            args: ["{that}", "{arguments}.0"]
        },
        getWorkingPath: {
            funcName: "gpii.iod.getWorkingPath",
            args: ["{arguments}.0"]
        }
    },

    members: {
        installations: {}
    }
});

/**
 * Create a directory where packages are temporarily stored.
 * @param packageName {String} Name of the package for which the directory is being created.
 */
gpii.iod.getWorkingPath = function (packageName) {
    var parts = [
        os.tmpdir(),
        "gpii-iod",
        packageName && packageName.replace(/[^a-z0-9]/, "_"),
        Math.random().toString(36)
    ];

    return parts.reduce(function (parent, child) {
        var dir = path.join(parent, child);
        try {
            fs.mkdirSync(dir);
        } catch (e) {
            if (e.code !== "EEXIST") {
                throw e;
            }
        }
        return dir;
    }, "");
};

/**
 * Finds a package installer component that handles the given type of package.
 *
 * @param that {Component} The gpii.iod instance.
 * @param packageType {string} The package type identifier.
 * @return {Component} A new instance of the gpii.iod.installer component that handles the requested type of package.
 */
gpii.iod.getInstaller = function (that, packageType) {
    var packageInstallers = fluid.queryIoCSelector(that, "gpii.iod.packageInstaller");

    var installerComponent = fluid.find(packageInstallers, function (installer) {
        var packageTypes = fluid.makeArray(installer.options.packageTypes);
        return packageTypes.indexOf(packageType) >= 0
            ? installer
            : undefined;
    });

    return installerComponent && fluid.invokeGlobalFunction(installerComponent.typeName);
};

/**
 * Starts the process of installing a package.
 *
 * @param that {Component} The gpii.iod instance.
 * @param packageName {string} The package name.
 * @return {Promise} Resolves when the installation is complete.
 */
gpii.iod.requirePackage = function (that, packageName) {
    fluid.log("IoD: Requiring " + packageName);

    var installation = {
        id: "aaa",
        packageName: packageName
    };
    that.installations[installation.id] = installation;

    var promise = fluid.promise();

    that.getPackageInfo(packageName).then(function (packageInfo) {
        var installer = that.getInstaller(packageInfo.packageType);
        if (installer) {
            var result = installer.startInstaller(packageInfo);
            fluid.promise.follow(result, promise);
        } else {
            promise.reject({
                isError: true,
                error: "Unable to find an installer for package type " + packageInfo.packageTypes
            });
        }
    });

    return promise.then(function () {
        fluid.log("IoD: Installation complete");
    }, function (err) {
        fluid.log("IoD: Installation failed:", err.error || err);
        var installation = err.installation;
        if (!installation) {
            installation = that.installations[packageName];
        }
        if (installation) {
            installation.failed = true;
            that.cleanup(installation);
        }
    });
};

/**
 * Retrieve the package metadata.
 *
 * @param that {Component} The gpii.iod instance.
 * @param installation {object} The installation state.
 * @return {Promise} Resolves to an object containing package information.
 */
gpii.iod.getPackageInfo = function (that, packageName) {
    fluid.log("IoD: Getting package info for " + packageName);

    var promise = fluid.promise();

    that.packageDataSource.get({packageName: packageName}).then(function (packageInfo) {
        promise.resolve(packageInfo);
    }, promise.reject);

    return promise;
};

/**
 * Starts the package removal routine.
 *
 * @param that {Component} The gpii.iod instance.
 * @param installation {object} The installation state.
 * @return {Promise} Resolves to an object containing package information and installation state.
 */
gpii.iod.startRemoval = function (that, installation) {
    if (typeof(installation) === "string") {
        installation = that.installations[installation];
    }

    if (!installation.installer) {
        installation.installer = that.getInstaller(installation.packageInfo.packageType);
    }

    fluid.log("IoD: Removing installation of " + installation.packageName);
    var promise = fluid.promise.fireTransformEvent(that.events.onRequirePackage, installation);
    return promise;
};

gpii.iod.uninstallPackage = function (that, installation) {
    installation.installer.uninstallPackage(installation);
};


