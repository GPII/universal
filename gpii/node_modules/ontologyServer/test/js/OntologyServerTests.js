/*!
GPII Canopy Ontology Server Tests

Copyright 2012 OCAD University

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

You may obtain a copy of the License at
https://github.com/gpii/universal/LICENSE.txt
*/

// Declare dependencies
/*global require, fluid, jqUnit, gpii, start*/

(function () {
    "use strict";

    var fluid = require("infusion");
    var gpii = fluid.registerNamespace("gpii");

    fluid.registerNamespace("gpii.tests.ontologyServer");

    var preferences = {
        flat: {
            "http://gpii.org/ontology/A4A-2.0/display/screenEnhancement/magnification": [{value: 2.0}],
            "http://gpii.org/ontology/A4A-2.0/display/screenEnhancement/tracking": [{value: "mouse"}],
            "http://gpii.org/ontology/A4A-2.0/display/screenEnhancement/invertImages": [{value: true}],
            "http://gpii.org/applications/some.application.id": [{
                "value": {
                    "some setting": true
                }
            }],
            "http://gpii.org/applications/some.other.application.id": [{
                "value": {
                    "some setting": true
                }
            }]
        },
        nested: {
            "display": {
                "screenEnhancement": {
                    "magnification": 2.0,
                    "tracking": "mouse",
                    "invertImages": true
                }
            }
        }
    };

    var transformations = {
        "A4A-2.0": {
            "display.screenEnhancement.fontSize": "{http://gpii.org/ontology/A4A-2.0/display/screenEnhancement/fontSize}.0.value",
            "display.screenEnhancement.tracking": "{http://gpii.org/ontology/A4A-2.0/display/screenEnhancement/tracking}.0.value",
            "display.screenEnhancement.invertImages": "{http://gpii.org/ontology/A4A-2.0/display/screenEnhancement/invertImages}.0.value",
            "applications": {
                "expander": {
                    "type": "gpii.ontologyServer.transform.application",
                    "inputPath": "*",
                    "outputPath": "applications"
                }
            }
        },
        "default": {
            "display.screenEnhancement.fontSize": "display.screenEnhancement.fontSize",
            "display.screenEnhancement.foregroundColor": "display.screenEnhancement.foregroundColor"
        }
    };

    gpii.tests.ontologyServer.runTests = function () {
        var testCase = jqUnit.TestCase("Utilities");
        
        testCase.test("ontologyServer.getOntologyName", function () {
            var expected = {
                flat: "A4A-2.0",
                nested: "default"
            };
            fluid.each(preferences, function (prefSet, type) {
                var actualName = ontologyServer.getOntologyName(prefSet);
                jqUnit.assertEquals("Ontology name is inferred correctly",
                    expected[type], actualName);
            });
        });

        testCase.test("ontologyServer.expandTransformations", function () {
            var expected = {
                "A4A-2.0": {
                    "display.screenEnhancement.fontSize": "http://gpii\\.org/ontology/A4A-2\\.0/display/screenEnhancement/fontSize.0.value",
                    "display.screenEnhancement.tracking": "http://gpii\\.org/ontology/A4A-2\\.0/display/screenEnhancement/tracking.0.value",
                    "display.screenEnhancement.invertImages": "http://gpii\\.org/ontology/A4A-2\\.0/display/screenEnhancement/invertImages.0.value",
                    "applications": {
                        "expander": {
                            "type": "gpii.ontologyServer.transform.application",
                            "inputPath": "*",
                            "outputPath": "applications"
                        }
                    }
                },
                "default": {
                    "display.screenEnhancement.fontSize": "display.screenEnhancement.fontSize",
                    "display.screenEnhancement.foregroundColor": "display.screenEnhancement.foregroundColor"
                }
            };
            fluid.each(expected, function (thisExpected, key) {
                jqUnit.assertDeepEq("Ontology transformation rules are expanded correctly.", thisExpected, ontologyServer.expandTransformations(transformations[key]));
            });
        });

        testCase.test("test application transformation rule expander", function () {
            var transformations = {
                "display.screenEnhancement.magnification": "http://gpii\\.org/ontology/A4A-2\\.0/display/screenEnhancement/magnification.0.value",
                "display.screenEnhancement.tracking": "http://gpii\\.org/ontology/A4A-2\\.0/display/screenEnhancement/tracking.0.value",
                "display.screenEnhancement.invertImages": "http://gpii\\.org/ontology/A4A-2\\.0/display/screenEnhancement/invertImages.0.value",
                "": {
                    "expander": {
                        "type": "gpii.ontologyServer.transform.application",
                        "inputPath": "",
                        "outputPath": "applications"
                    }
                }
            };
            jqUnit.assertDeepEq("Ontology transformation rules are expanded correctly.", {
                applications: {
                    "some.application.id": {
                        "id": "some.application.id",
                        "parameters": {
                            "some setting": true
                        }
                    },
                    "some.other.application.id": {
                        "id": "some.other.application.id",
                        "parameters": {
                            "some setting": true
                        }
                    }
                },
                display: {
                    screenEnhancement: {
                        magnification: 2.0,
                        tracking: "mouse",
                        invertImages: true
                    }
                }
            }, fluid.model.transformWithRules(preferences.flat, transformations));
        });
    };

}());