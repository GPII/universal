/**
GPII Preferences Server Tests

Copyright 2014 Raising the Floor - International
Copyright 2018 OCAD University

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

The research leading to these results has received funding from the European Union's
Seventh Framework Programme (FP7/2007-2013) under grant agreement no. 289016.

You may obtain a copy of the License at
https://github.com/GPII/universal/blob/master/LICENSE.txt
*/

"use strict";

var fluid = require("infusion"),
    jqUnit = fluid.registerNamespace("jqUnit"),
    gpii = fluid.registerNamespace("gpii");

require("preferencesServer");
require("gpii-pouchdb");

gpii.pouch.loadTestingSupport();
fluid.setLogging(true);
fluid.logObjectRenderChars = 10240;

require("./preferencesServerTestsUtils.js");
fluid.require("%dbOperation/test/js/DataStoreTestsUtils.js");   // reuse gpii.tests.dbOperation.invokePromiseProducer()

fluid.registerNamespace("gpii.tests.preferencesServer");

/////////////////////// TESTING preferencesServer getPreferences() functionality ////////////////////////////
// 1. success workflows
gpii.tests.preferencesServer.getPreferencesSuccessFixtures = [
    {
        name: "getPreferences(): Basic retrieval of simple preferences set in same ontology (no parameter)",
        gpiiKey: "np_flatOnly_singleContext",
        expected: {
            "name": "Single set",
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "http://registry.gpii.net/common/onScreenKeyboard/enabled": true,
                        "http://registry.gpii.net/common/initDelay": 0.120,
                        "http://registry.gpii.net/common/cursorSpeed": 0.850,
                        "http://registry.gpii.net/common/cursorAcceleration": 0.800,
                        "http://registry.gpii.net/common/mouseEmulation/enabled": true,
                        "http://registry.gpii.net/common/unknown": true,
                        "http://registry.gpii.net/applications/org.alsa-project": {
                            "volume": 14,
                            "pitch": 100
                        }
                    },
                    "metadata": [{
                        "type": "provenance",
                        "scope": ["http://registry\\.gpii\\.net/applications/org\\.alsa-project"],
                        "source": "snapshotter"
                    }, {
                        "type": "required",
                        "scope": ["*"]
                    }]
                }
            },
            "metadata": [
                {
                    "type": "doNotShare",
                    "scope": [ "http://registry\\.gpii\\.net/common/fontSize"]
                }
            ]
        }
    }, {
        name: "getPreferences(): Basic retrieval of simple preferences set in same ontology (with parameter)",
        gpiiKey: "np_flatOnly_singleContext",
        view: "flat",
        expected: {
            "name": "Single set",
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "http://registry.gpii.net/common/onScreenKeyboard/enabled": true,
                        "http://registry.gpii.net/common/initDelay": 0.120,
                        "http://registry.gpii.net/common/cursorSpeed": 0.850,
                        "http://registry.gpii.net/common/cursorAcceleration": 0.800,
                        "http://registry.gpii.net/common/mouseEmulation/enabled": true,
                        "http://registry.gpii.net/common/unknown": true,
                        "http://registry.gpii.net/applications/org.alsa-project": {
                            "volume": 14,
                            "pitch": 100
                        }
                    },
                    "metadata": [{
                        "type": "provenance",
                        "scope": ["http://registry\\.gpii\\.net/applications/org\\.alsa-project"],
                        "source": "snapshotter"
                    }, {
                        "type": "required",
                        "scope": ["*"]
                    }]
                }
            },
            "metadata": [
                {
                    "type": "doNotShare",
                    "scope": [ "http://registry\\.gpii\\.net/common/fontSize"]
                }
            ]
        }
    }, {
        name: "getPreferences(): Basic retrieval of simple preferences set in different ontology (with parameter)",
        gpiiKey: "np_ISO24751Only_singleContext",
        view: "flat",
        expected: {
            "name": "ISO24751 set",
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "http://registry.gpii.net/common/onScreenKeyboard/enabled": true,
                        "http://registry.gpii.net/common/initDelay": 0.120,
                        "http://registry.gpii.net/common/cursorSpeed": 0.850,
                        "http://registry.gpii.net/common/cursorAcceleration": 0.800,
                        "http://registry.gpii.net/common/mouseEmulation/enabled": true,
                        "http://registry.gpii.net/applications/org.alsa-project": {
                            "volume": 14,
                            "pitch": 100
                        }
                    },
                    "metadata": [{
                        "type": "provenance",
                        "scope": ["http://registry\\.gpii\\.net/applications/org\\.alsa-project"],
                        "source": "snapshotter"
                    }]
                }
            },
            "metadata": [
                {
                    "type": "doNotShare",
                    "scope": [ "http://registry\\.gpii\\.net/common/fontSize"]
                }
            ]
        }
    }, {
        name: "getPreferences(): Retrieval of simple preferences set in different ontology plus non-translateable preference",
        gpiiKey: "np_flatOnly_singleContext",
        view: "ISO24751",
        expected: {
            "name": "Single set",
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "control": {
                            "onscreenKeyboard": true,
                            "mouseEmulation": {
                                "cursorSpeed": 0.85,
                                "cursorAcceleration": 0.8,
                                "-provisional-initDelay": 0.12,
                                "-provisional-mouseEmulation/enabled": true
                            }
                        },
                        "applications": {
                            "org.alsa-project": {
                                "id": "org.alsa-project",
                                "parameters": {
                                    "volume": 14,
                                    "pitch": 100
                                }
                            }
                        }
                    },
                    "metadata": [
                        {
                            "type": "provenance",
                            "scope": ["applications.org\\.alsa-project.parameters"],
                            "source": "snapshotter"
                        }, {
                            "type": "required",
                            "scope": ["*"]
                        }
                    ]
                }
            },
            "metadata": [
                {
                    "type": "doNotShare",
                    "scope": [ "display.screenEnhancement.fontSize"]
                }
            ]
        }
    }, {
        name: "getPreferences(): Retrieval of single ontology, multi-context preferences set in same ontology",
        gpiiKey: "np_flatOnly_multiContext",
        view: "flat",
        expected: {
            "name": "Multiple Contexts",
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "http://registry.gpii.net/common/cursorAcceleration": 0.800,
                        "http://registry.gpii.net/common/mouseEmulation/enabled": true,
                        "http://registry.gpii.net/common/unknown": true,
                        "http://registry.gpii.net/applications/org.alsa-project": {
                            "volume": 14,
                            "pitch": 100
                        }
                    },
                    "metadata": [
                        {
                            "type": "provenance",
                            "scope": ["http://registry\\.gpii\\.net/common/fontSize"],
                            "source": "snapshotter"
                        }
                    ]
                },
                "gpii-xyz1234": {
                    "name": "Nighttime at home",
                    "preferences": {
                        "http://registry.gpii.net/common/cursorSpeed": 1,
                        "http://registry.gpii.net/common/cursorAcceleration": 1
                    },
                    "conditions": [
                        {
                            "type": "http://registry.gpii.net/conditions/timeOfDay",
                            "range": {
                                "start": 1730,
                                "end": 730
                            }
                        }
                    ],
                    "priority": 100
                }
            },
            "metadata": [
                {
                    "type": "doNotShare",
                    "scope": [ "http://registry\\.gpii\\.net/common/fontSize"]
                }
            ]
        }
    }, {
        name: "getPreferences(): Retrieval of single ontology, multi-context preferences set in a different ontology",
        gpiiKey: "np_flatOnly_multiContext",
        view: "ISO24751",
        expected: {
            "name": "Multiple Contexts",
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "control": {
                            "mouseEmulation": {
                                "cursorAcceleration": 0.8,
                                "-provisional-mouseEmulation/enabled": true
                            }
                        },
                        "applications": {
                            "org.alsa-project": {
                                "id": "org.alsa-project",
                                "parameters": {
                                    "volume": 14,
                                    "pitch": 100
                                }
                            }
                        }
                    },
                    "metadata": [
                        {
                            "type": "provenance",
                            "scope": ["display.screenEnhancement.fontSize"],
                            "source": "snapshotter"
                        }
                    ]
                },
                "gpii-xyz1234": {
                    "name": "Nighttime at home",
                    "preferences": {
                        "control": {
                            "mouseEmulation": {
                                "cursorSpeed": 1,
                                "cursorAcceleration": 1
                            }
                        }
                    },
                    "conditions": [
                        {
                            "type": "http://registry.gpii.net/conditions/timeOfDay",
                            "range": {
                                "start": 1730,
                                "end": 730
                            }
                        }
                    ],
                    "priority": 100
                }
            },
            "metadata": [
                {
                    "type": "doNotShare",
                    "scope": [ "display.screenEnhancement.fontSize"]
                }
            ]
        }
    }, {
        name: "getPreferences(): Retrieval of mixed preferences set in flat (from multiple ontologies, single context)",
        gpiiKey: "np_mixed_singleContext",
        view: "flat",
        expected: {
            "name": "lotta stuff",
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "http://registry.gpii.net/common/onScreenKeyboard/enabled": true,
                        "http://registry.gpii.net/common/initDelay": 0.120,
                        "http://registry.gpii.net/common/cursorSpeed": 0.850,
                        "http://registry.gpii.net/common/cursorAcceleration": 0.800,
                        "http://registry.gpii.net/common/mouseEmulation/enabled": true,
                        "http://registry.gpii.net/common/flatOnly": true,
                        "http://registry.gpii.net/common/fontSize": 24,
                        "http://registry.gpii.net/applications/org.alsa-project": {
                            "volume": 14
                        }
                    },
                    "metadata": [
                        {
                            "type": "required",
                            "scope": ["*"]
                        }, {
                            "type": "provenance",
                            "scope": ["http://registry\\.gpii\\.net/common/fontSize"],
                            "source": "snapshotter"
                        }
                    ]
                }
            }
        }
    }, {
        name: "getPreferences(): Retrieval of mixed preferences set in flat (from multiple ontologies, multi context)",
        gpiiKey: "np_mixed_multiContext",
        view: "flat",
        expected: {
            "name": "lotta stuff",
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "http://registry.gpii.net/common/initDelay": 0.120,
                        "http://registry.gpii.net/common/cursorSpeed": 0.850,
                        "http://registry.gpii.net/common/cursorAcceleration": 0.800,
                        "http://registry.gpii.net/common/mouseEmulation/enabled": true,
                        "http://registry.gpii.net/common/flatOnly": true,
                        "http://registry.gpii.net/common/onScreenKeyboard/enabled": true,
                        "http://registry.gpii.net/applications/org.alsa-project": {
                            "volume": 14,
                            "pitch": 100
                        },
                        "http://registry.gpii.net/applications/org.gnome.desktop.a11y.magnifier": {
                            "show-cross-hairs": true,
                            "lens-mode": false
                        }
                    },
                    "metadata": [
                        {
                            "type": "provenance",
                            "scope": ["http://registry\\.gpii\\.net/common/fontSize"],
                            "source": "snapshotter"
                        }
                    ]
                },
                "gpii-xyz1234": {
                    "name": "Nighttime at home",
                    "preferences": {
                        "http://registry.gpii.net/common/cursorSpeed": 1,
                        "http://registry.gpii.net/common/cursorAcceleration": 1
                    },
                    "conditions": [
                        {
                            "type": "http://registry.gpii.net/conditions/timeOfDay",
                            "range": {
                                "start": 1730,
                                "end": 730
                            }
                        }
                    ],
                    "priority": 100
                }
            },
            "metadata": [
                {
                    "type": "doNotShare",
                    "scope": [ "http://registry\\.gpii\\.net/common/fontSize"]
                }, {
                    "type": "doNotShare",
                    "scope": [ "http://registry\\.gpii\\.net/common/magnification"]
                }
            ]
        }
    }, {
        name: "getPreferences(): Retrieval of mixed preferences set in ISO24751 (from multiple ontologies, multi context)",
        gpiiKey: "np_mixed_multiContext",
        view: "ISO24751",
        expected: {
            "name": "lotta stuff",
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "control": {
                            "onscreenKeyboard": true,
                            "mouseEmulation": {
                                "cursorSpeed": 0.85,
                                "cursorAcceleration": 0.8,
                                "-provisional-initDelay": 0.12,
                                "-provisional-mouseEmulation/enabled": true
                            }
                        },
                        "applications": {
                            "org.alsa-project": {
                                "id": "org.alsa-project",
                                "parameters": {
                                    "volume": 14,
                                    "pitch": 100
                                }
                            },
                            "org.gnome.desktop.a11y.magnifier": {
                                "id": "org.gnome.desktop.a11y.magnifier",
                                "parameters": {
                                    "show-cross-hairs": true,
                                    "lens-mode": false
                                }
                            }
                        }
                    },
                    "metadata": [
                        {
                            "type": "provenance",
                            "scope": ["display.screenEnhancement.fontSize"],
                            "source": "snapshotter"
                        }
                    ]
                },
                "gpii-xyz1234": {
                    "name": "Nighttime at home",
                    "preferences": {
                        "control": {
                            "mouseEmulation": {
                                "cursorSpeed": 1,
                                "cursorAcceleration": 1
                            }
                        }
                    },
                    "conditions": [
                        {
                            "type": "http://registry.gpii.net/conditions/timeOfDay",
                            "range": {
                                "start": 1730,
                                "end": 730
                            }
                        }
                    ],
                    "priority": 100
                }
            },
            "metadata": [
                {
                    "type": "doNotShare",
                    "scope": [ "display.screenEnhancement.fontSize"]
                }, {
                    "type": "doNotShare",
                    "scope": [ "display.screenEnhancement.magnification"]
                }
            ]
        }
    }, {
        name: "getPreferences(): Complex retrieval of simple preferences set in different ontology (with parameter)",
        gpiiKey: "np_ISO24751Only_singleContext_wildcardMetadata",
        view: "flat",
        expected: {
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "http://registry.gpii.net/common/initDelay": 0.12,
                        "http://registry.gpii.net/common/cursorSpeed": 0.85,
                        "http://registry.gpii.net/common/cursorAcceleration": 0.8,
                        "http://registry.gpii.net/common/mouseEmulation/enabled": true,
                        "http://registry.gpii.net/applications/org.alsa-project": {
                            "volume": 14,
                            "pitch": 100
                        },
                        "http://registry.gpii.net/common/onScreenKeyboard/enabled": true
                    },
                    "metadata": [
                        {
                            "type": "provenance",
                            "scope": [
                                "http://registry\\.gpii\\.net/common/initDelay",
                                "http://registry\\.gpii\\.net/common/stickyKeys",
                                "http://registry\\.gpii\\.net/common/cursorSpeed",
                                "http://registry\\.gpii\\.net/common/speechControl",
                                "http://registry\\.gpii\\.net/common/hapticFeedback",
                                "http://registry\\.gpii\\.net/common/tableOfContents",
                                "http://registry\\.gpii\\.net/common/slowKeysInterval",
                                "http://registry\\.gpii\\.net/common/slowKeys/enabled",
                                "http://registry\\.gpii\\.net/common/debounce/enabled",
                                "http://registry\\.gpii\\.net/common/debounceInterval",
                                "http://registry\\.gpii\\.net/common/cursorAcceleration",
                                "http://registry\\.gpii\\.net/common/mouseEmulation/enabled",
                                "http://registry\\.gpii\\.net/common/onScreenKeyboard/enabled"
                            ],
                            "source": "snapshotter"
                        }
                    ]
                }
            },
            "name": "ISO24751 set",
            "metadata": [
                {
                    "type": "doNotShare",
                    "scope": [
                        "http://registry\\.gpii\\.net/common/fontSize",
                        "http://registry\\.gpii\\.net/common/tracking",
                        "http://registry\\.gpii\\.net/common/DPIScale",
                        "http://registry\\.gpii\\.net/common/lineSpace",
                        "http://registry\\.gpii\\.net/common/cursorSize",
                        "http://registry\\.gpii\\.net/common/trackingTTS",
                        "http://registry\\.gpii\\.net/common/invertImages",
                        "http://registry\\.gpii\\.net/common/magnification",
                        "http://registry\\.gpii\\.net/common/invertColours",
                        "http://registry\\.gpii\\.net/common/mouseTrailing",
                        "http://registry\\.gpii\\.net/common/characterSpace",
                        "http://registry\\.gpii\\.net/common/highlightColor",
                        "http://registry\\.gpii\\.net/common/foregroundColor",
                        "http://registry\\.gpii\\.net/common/backgroundColor",
                        "http://registry\\.gpii\\.net/common/fontFaceFontName",
                        "http://registry\\.gpii\\.net/common/magnifierPosition",
                        "http://registry\\.gpii\\.net/common/highContrastTheme",
                        "http://registry\\.gpii\\.net/common/inputsLarger/enabled",
                        "http://registry\\.gpii\\.net/common/highContrast/enabled",
                        "http://registry\\.gpii\\.net/common/magnification/enabled",
                        "http://registry\\.gpii\\.net/common/fontFaceGenericFontFace"
                    ]
                }
            ]
        }
    }, {
        name: "getPreferences(): Preferences have not been defined for the GPII key",
        gpiiKey: "undefined_preferences",
        expected: undefined
    }
];

gpii.tests.preferencesServer.getPreferencesSuccessSequence = [{
    func: "gpii.tests.dbOperation.invokePromiseProducer",
    args: ["{preferencesServer}.getPreferences", ["{gpii.tests.preferencesServer.environment}.options.gpiiKey", "{gpii.tests.preferencesServer.environment}.options.view"], "{that}"]
}, {
    listener: "jqUnit.assertDeepEq",
    args: ["The expected preferences are received", "{gpii.tests.preferencesServer.environment}.options.expected", "{arguments}.0"],
    event: "{that}.events.onResponse"
}];

// 2. getPreferences() by a nonexistent GPII key returns an error
gpii.tests.preferencesServer.getPreferencesErrorFixtures = [{
    name: "getPreferences(): Retrieving preferences by a nonexistent GPII key returns an error",
    gpiiKey: "non-existent-gpii-key",
    expected: {
        message: "GPII key \"non-existent-gpii-key\" does not exist"
    }
}];

gpii.tests.preferencesServer.getPreferencesErrorSequence = [{
    func: "gpii.tests.dbOperation.invokePromiseProducer",
    args: ["{preferencesServer}.getPreferences", ["{gpii.tests.preferencesServer.environment}.options.gpiiKey", "{gpii.tests.preferencesServer.environment}.options.view"], "{that}"]
}, {
    listener: "jqUnit.assertDeepEq",
    args: ["The expected preferences are received", "{gpii.tests.preferencesServer.environment}.options.expected", "{arguments}.0"],
    event: "{that}.events.onError"
}];

/////////////////////// TESTING preferencesServer createPreferences() functionality ////////////////////////////

// createPreferences() success cases
gpii.tests.preferencesServer.createPreferencesSuccessFixtures = [
    {
        name: "createPreferences(): With no gpiiKey specified and no ontology specified",
        preferences: {
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "http://registry.gpii.net/common/onScreenKeyboard/enabled": true,
                        "http://registry.gpii.net/common/initDelay": 0.120,
                        "http://registry.gpii.net/common/cursorSpeed": 0.850,
                        "http://registry.gpii.net/common/cursorAcceleration": 0.800,
                        "http://registry.gpii.net/common/mouseEmulation/enabled": true,
                        "http://registry.gpii.net/common/unknown": true,
                        "http://registry.gpii.net/applications/org.alsa-project": {
                            "volume": 14,
                            "pitch": 100
                        }
                    },
                    "metadata": [
                        {
                            "type": "provenance",
                            "scope": ["http://registry.gpii.net/common/fontSize"],
                            "source": "snapshotter"
                        }
                    ]
                }
            }
        }
    }, {
        name: "createPreferences(): With no gpiiKey specified and ontology specified",
        view: "flat",
        preferences: {
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "http://registry.gpii.net/common/onScreenKeyboard/enabled": true,
                        "http://registry.gpii.net/common/initDelay": 0.120,
                        "http://registry.gpii.net/common/cursorSpeed": 0.850,
                        "http://registry.gpii.net/common/cursorAcceleration": 0.800,
                        "http://registry.gpii.net/common/mouseEmulation/enabled": true,
                        "http://registry.gpii.net/common/unknown": true,
                        "http://registry.gpii.net/applications/org.alsa-project": {
                            "volume": 14,
                            "pitch": 100
                        }
                    },
                    "metadata": [
                        {
                            "type": "provenance",
                            "scope": ["http://registry.gpii.net/common/fontSize"],
                            "source": "snapshotter"
                        }
                    ]
                }
            }
        }
    }, {
        name: "createPreferences(): With no gpiiKey specified and non-flat ontology specified",
        view: "ISO",
        preferences: {
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "http://registry.gpii.net/common/onScreenKeyboard/enabled": true,
                        "http://registry.gpii.net/applications/org.alsa-project": {
                            "volume": 14,
                            "pitch": 100
                        }
                    }
                }
            }
        }
    }, {
        name: "createPreferences(): With gpiiKey specified and non-flat ontology specified",
        view: "ISO",
        gpiiKey: "a-new-key-from-prefsServerTest",
        preferences: {
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "http://registry.gpii.net/common/onScreenKeyboard/enabled": true,
                        "http://registry.gpii.net/applications/org.alsa-project": {
                            "volume": 14,
                            "pitch": 100
                        }
                    }
                }
            }
        }
    }
];

gpii.tests.preferencesServer.createPreferencesSuccessSequence = [{
    func: "gpii.tests.dbOperation.invokePromiseProducer",
    args: ["{preferencesServer}.createPreferences", ["{gpii.tests.preferencesServer.environment}.options.preferences", "{gpii.tests.preferencesServer.environment}.options.view", "{gpii.tests.preferencesServer.environment}.options.gpiiKey"], "{that}"]
}, {
    listener: "gpii.tests.preferencesServer.verifyCreatedPreferences",
    args: ["{gpii.tests.preferencesServer.environment}.options.preferences", "{arguments}.0", "{gpii.tests.preferencesServer.environment}.options.view", "{gpii.tests.preferencesServer.environment}.options.gpiiKey"],
    event: "{that}.events.onResponse"
}];

gpii.tests.preferencesServer.verifyCreatedPreferences = function (preferences, response, view, expectedGpiiKey) {
    view = view || "flat";
    if (expectedGpiiKey) {
        jqUnit.assertEquals("The \"gpiiKey\" is expected", expectedGpiiKey, response.gpiiKey);
    } else {
        jqUnit.assertNotUndefined("The \"gpiiKey\" is returned", response.gpiiKey);
    }
    jqUnit.assertDeepEq("The returned \"preferences\" value matches the input", preferences, fluid.get(response, ["preferences", view]));
};

// createPreferences() error cases
gpii.tests.preferencesServer.createPreferencesErrorFixtures = [
    {
        name: "createPreferences(): return error if preferences is not provided",
        expectedMsg: gpii.preferencesServer.errors.missingPreferences
    }
];

gpii.tests.preferencesServer.createPreferencesErrorSequence = [{
    func: "gpii.tests.dbOperation.invokePromiseProducer",
    args: ["{preferencesServer}.createPreferences", ["{gpii.tests.preferencesServer.environment}.options.preferences", "{gpii.tests.preferencesServer.environment}.options.view"], "{that}"]
}, {
    listener: "gpii.tests.preferencesServer.verifyError",
    args: ["{gpii.tests.preferencesServer.environment}.options.expectedMsg", "{arguments}.0"],
    event: "{that}.events.onError"
}];

/////////////////////// TESTING preferencesServer updatePreferences() functionality ////////////////////////////

// updatePreferences() success cases
gpii.tests.preferencesServer.updatePreferencesSuccessFixtures = [
    {
        name: "updatePreferences(): No view specified, ontology matching preferences set",
        gpiiKey: "np_flatOnly_singleContext",
        view: undefined,
        preferences: {
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "http://registry.gpii.net/common/onScreenKeyboard/enabled": false
                    },
                    "metadata": [
                        {
                            "type": "required",
                            "scope": ["*"]
                        }
                    ]
                }
            },
            "metadata": [
                {
                    "type": "doNotShare",
                    "scope": [ "http://registry\\.gpii\\.net/common/fontSize"]
                }
            ]
        },
        expectedRaw: {
            "flat": {
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "http://registry.gpii.net/common/onScreenKeyboard/enabled": false
                        },
                        "metadata": [
                            {
                                "type": "required",
                                "scope": [
                                    "*"
                                ]
                            }
                        ]
                    }
                },
                "metadata": [
                    {
                        "type": "doNotShare",
                        "scope": [
                            "http://registry\\.gpii\\.net/common/fontSize"
                        ]
                    }
                ]
            }
        }
    }, {
        name: "updatePreferences(): No view specified, ontology matching preferences set, with mergePrefs turned on to merge the new preferences with the existing preferences",
        gpiiKey: "np_flatOnly_singleContext",
        view: undefined,
        mergePrefs: true,
        preferences: {
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "http://registry.gpii.net/common/onScreenKeyboard/enabled": false
                    },
                    "metadata": [
                        {
                            "type": "required",
                            "scope": ["*"]
                        }
                    ]
                }
            },
            "metadata": [
                {
                    "type": "doNotShare",
                    "scope": [ "http://registry\\.gpii\\.net/common/fontSize"]
                }
            ]
        },
        expectedRaw: {
            "flat": {
                "name": "Single set",
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "http://registry.gpii.net/common/onScreenKeyboard/enabled": false,
                            "http://registry.gpii.net/common/initDelay": 0.12,
                            "http://registry.gpii.net/common/cursorSpeed": 0.85,
                            "http://registry.gpii.net/common/cursorAcceleration": 0.8,
                            "http://registry.gpii.net/common/mouseEmulation/enabled": true,
                            "http://registry.gpii.net/common/unknown": true,
                            "http://registry.gpii.net/applications/org.alsa-project": {
                                "volume": 14,
                                "pitch": 100
                            }
                        },
                        "metadata": [
                            {
                                "type": "required",
                                "scope": ["*"],
                                "source": "snapshotter"
                            },
                            {
                                "type": "required",
                                "scope": [
                                    "*"
                                ]
                            }
                        ]
                    }
                },
                "metadata": [
                    {
                        "type": "doNotShare",
                        "scope": [
                            "http://registry\\.gpii\\.net/common/fontSize"
                        ]
                    }
                ]
            }
        }
    }, {
        name: "updatePreferences(): To preferences set containing same preference in different ontology",
        gpiiKey: "np_tiny",
        view: "ISO24751",
        preferences: {
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "control": {
                            "onscreenKeyboard": false
                        }
                    }
                }
            }
        },
        expectedRaw: {
            "flat": {
                "name": "bit of stuff",
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {}
                    }
                }
            },
            "ISO24751": {
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "control": {
                                "onscreenKeyboard": false
                            }
                        }
                    }
                }
            }
        }
    }, {
        name: "updatePreferences(): To preferences set containing same preference in different ontology, with mergePrefs turned on to merge the new preferences with the existing preferences",
        gpiiKey: "np_tiny",
        view: "ISO24751",
        mergePrefs: true,
        preferences: {
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "control": {
                            "onscreenKeyboard": false
                        }
                    }
                }
            }
        },
        expectedRaw: {
            "flat": {
                "name": "bit of stuff",
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "http://registry.gpii.net/common/onScreenKeyboard/enabled": true
                        },
                        "metadata": []
                    }
                },
                "metadata": []
            },
            "ISO24751": {
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "control": {
                                "onscreenKeyboard": false
                            }
                        }
                    }
                }
            }
        }
    }, {
        name: "updatePreferences(): Overwriting one view and modifying another",
        gpiiKey: "np_mixed_singleContext",
        view: "ISO24751",
        preferences: {
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "control": {
                            "mouseEmulation": {
                                "cursorSpeed": 1
                            }
                        }
                    }
                }
            }
        },
        expectedRaw: {
            "flat": {
                "name": "lotta stuff",
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "http://registry.gpii.net/common/onScreenKeyboard/enabled": true,
                            "http://registry.gpii.net/common/initDelay": 0.12,
                            "http://registry.gpii.net/common/cursorAcceleration": 0.8,
                            "http://registry.gpii.net/common/mouseEmulation/enabled": true,
                            "http://registry.gpii.net/common/flatOnly": true,
                            "http://registry.gpii.net/applications/org.alsa-project": {
                                "volume": 14
                            }
                        },
                        "metadata": [
                            {
                                "type": "required",
                                "scope": [
                                    "*"
                                ]
                            }
                        ]
                    }
                }
            },
            "ISO24751": {
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "control": {
                                "mouseEmulation": {
                                    "cursorSpeed": 1
                                }
                            }
                        }
                    }
                }
            },
            "bogus": {
                "contexts": {
                    "gpii-default": {
                        "preferences": {
                            "foo": "bar"
                        }
                    }
                }
            }
        }
    }, {
        name: "updatePreferences(): Overwriting one view and modifying another, with mergePrefs turned on to merge the new preferences with the existing preferences",
        gpiiKey: "np_mixed_singleContext",
        view: "ISO24751",
        mergePrefs: true,
        preferences: {
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "control": {
                            "mouseEmulation": {
                                "cursorSpeed": 1
                            }
                        }
                    }
                }
            }
        },
        expectedRaw: {
            "flat": {
                "name": "lotta stuff",
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "http://registry.gpii.net/common/onScreenKeyboard/enabled": true,
                            "http://registry.gpii.net/common/initDelay": 0.12,
                            "http://registry.gpii.net/common/cursorSpeed": 0.85,
                            "http://registry.gpii.net/common/cursorAcceleration": 0.8,
                            "http://registry.gpii.net/common/mouseEmulation/enabled": true,
                            "http://registry.gpii.net/common/flatOnly": true,
                            "http://registry.gpii.net/applications/org.alsa-project": {
                                "volume": 14
                            }
                        },
                        "metadata": [
                            {
                                "type": "required",
                                "scope": [
                                    "*"
                                ]
                            }
                        ]
                    }
                }
            },
            "ISO24751": {
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "display": {
                                "screenEnhancement": {
                                    "fontSize": 24
                                }
                            },
                            "control": {
                                "mouseEmulation": {
                                    "cursorSpeed": 1
                                }
                            }
                        },
                        "metadata": [
                            {
                                "type": "provenance",
                                "scope": [
                                    "display.screenEnhancement.fontSize"
                                ],
                                "source": "snapshotter"
                            }
                        ]
                    }
                }
            },
            "bogus": {
                "contexts": {
                    "gpii-default": {
                        "preferences": {
                            "foo": "bar"
                        }
                    }
                }
            }
        }
    }, {
        name: "updatePreferences(): Overwriting app specific block in one view with new ones from another view",
        gpiiKey: "np_mixed_singleContext",
        view: "ISO24751",
        preferences: {
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "applications": {
                            "org.alsa-project": {
                                "parameters": {
                                    "bass": "damn loud"
                                }
                            }
                        }
                    }
                }
            }
        },
        expectedRaw: {
            "flat": {
                "name": "lotta stuff",
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "http://registry.gpii.net/common/onScreenKeyboard/enabled": true,
                            "http://registry.gpii.net/common/initDelay": 0.12,
                            "http://registry.gpii.net/common/cursorSpeed": 0.85,
                            "http://registry.gpii.net/common/cursorAcceleration": 0.8,
                            "http://registry.gpii.net/common/mouseEmulation/enabled": true,
                            "http://registry.gpii.net/common/flatOnly": true,
                            "http://registry.gpii.net/applications/org.alsa-project": {
                                "volume": 14
                            }
                        },
                        "metadata": [
                            {
                                "type": "required",
                                "scope": [
                                    "*"
                                ]
                            }
                        ]
                    }
                }
            },
            "ISO24751": {
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "applications": {
                                "org.alsa-project": {
                                    "parameters": {
                                        "bass": "damn loud"
                                    }
                                }
                            }
                        }
                    }
                }
            },
            "bogus": {
                "contexts": {
                    "gpii-default": {
                        "preferences": {
                            "foo": "bar"
                        }
                    }
                }
            }
        }
    }, {
        name: "updatePreferences(): Overwriting app specific block in one view with new ones from another view, with mergePrefs turned on to merge the new preferences with the existing preferences",
        gpiiKey: "np_mixed_singleContext",
        view: "ISO24751",
        mergePrefs: true,
        preferences: {
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "applications": {
                            "org.alsa-project": {
                                "parameters": {
                                    "bass": "damn loud"
                                }
                            }
                        }
                    }
                }
            }
        },
        expectedRaw: {
            "flat": {
                "name": "lotta stuff",
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "http://registry.gpii.net/common/onScreenKeyboard/enabled": true,
                            "http://registry.gpii.net/common/initDelay": 0.12,
                            "http://registry.gpii.net/common/cursorSpeed": 0.85,
                            "http://registry.gpii.net/common/cursorAcceleration": 0.8,
                            "http://registry.gpii.net/common/mouseEmulation/enabled": true,
                            "http://registry.gpii.net/common/flatOnly": true,
                            "http://registry.gpii.net/applications/org.alsa-project": {
                                "volume": 14
                            }
                        },
                        "metadata": [
                            {
                                "type": "required",
                                "scope": [
                                    "*"
                                ]
                            }
                        ]
                    }
                }
            },
            "ISO24751": {
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "display": {
                                "screenEnhancement": {
                                    "fontSize": 24
                                }
                            },
                            "applications": {
                                "org.alsa-project": {
                                    "parameters": {
                                        "bass": "damn loud"
                                    }
                                }
                            }
                        },
                        "metadata": [
                            {
                                "type": "provenance",
                                "scope": [
                                    "display.screenEnhancement.fontSize"
                                ],
                                "source": "snapshotter"
                            }
                        ]
                    }
                }
            },
            "bogus": {
                "contexts": {
                    "gpii-default": {
                        "preferences": {
                            "foo": "bar"
                        }
                    }
                }
            }
        }
    }, {
        name: "updatePreferences(): System shouldn't act crazy when saving with wildcard metadata",
        gpiiKey: "np_flatOnly_singleContext",
        view: "ISO24751",
        preferences: {
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "control": {
                            "onscreenKeyboard": false
                        }
                    },
                    "metadata": [{
                        "type": "required",
                        "scope": ["control.*"]
                    }]
                }
            }
        },
        expectedRaw: {
            "flat": {
                "name": "Single set",
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "http://registry.gpii.net/common/initDelay": 0.12,
                            "http://registry.gpii.net/common/cursorSpeed": 0.85,
                            "http://registry.gpii.net/common/cursorAcceleration": 0.8,
                            "http://registry.gpii.net/common/mouseEmulation/enabled": true,
                            "http://registry.gpii.net/common/unknown": true,
                            "http://registry.gpii.net/applications/org.alsa-project": {
                                "volume": 14,
                                "pitch": 100
                            }
                        },
                        "metadata": [
                            {
                                "type": "provenance",
                                "scope": [
                                    "http://registry\\.gpii\\.net/applications/org\\.alsa-project"
                                ],
                                "source": "snapshotter"
                            },
                            {
                                "type": "required",
                                "scope": [
                                    "*"
                                ]
                            }
                        ]
                    }
                },
                "metadata": [
                    {
                        "type": "doNotShare",
                        "scope": [
                            "http://registry\\.gpii\\.net/common/fontSize"
                        ]
                    }
                ]
            },
            "ISO24751": {
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "control": {
                                "onscreenKeyboard": false
                            }
                        },
                        "metadata": [{
                            "type": "required",
                            "scope": ["control.*"]
                        }]
                    }
                }
            }
        }
    }, {
        name: "updatePreferences(): System shouldn't act crazy when saving with wildcard metadata, with mergePrefs turned on to merge the new preferences with the existing preferences",
        gpiiKey: "np_flatOnly_singleContext",
        view: "ISO24751",
        mergePrefs: true,
        preferences: {
            "contexts": {
                "gpii-default": {
                    "name": "Default preferences",
                    "preferences": {
                        "control": {
                            "onscreenKeyboard": false
                        }
                    },
                    "metadata": [{
                        "type": "required",
                        "scope": ["control.*"]
                    }]
                }
            }
        },
        expectedRaw: {
            "flat": {
                "name": "Single set",
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "http://registry.gpii.net/common/onScreenKeyboard/enabled": true,
                            "http://registry.gpii.net/common/initDelay": 0.12,
                            "http://registry.gpii.net/common/cursorSpeed": 0.85,
                            "http://registry.gpii.net/common/cursorAcceleration": 0.8,
                            "http://registry.gpii.net/common/mouseEmulation/enabled": true,
                            "http://registry.gpii.net/common/unknown": true,
                            "http://registry.gpii.net/applications/org.alsa-project": {
                                "volume": 14,
                                "pitch": 100
                            }
                        },
                        "metadata": [
                            {
                                "type": "provenance",
                                "scope": [
                                    "http://registry\\.gpii\\.net/applications/org\\.alsa-project"
                                ],
                                "source": "snapshotter"
                            },
                            {
                                "type": "required",
                                "scope": [
                                    "*"
                                ]
                            }
                        ]
                    }
                },
                "metadata": [
                    {
                        "type": "doNotShare",
                        "scope": [
                            "http://registry\\.gpii\\.net/common/fontSize"
                        ]
                    }
                ]
            },
            "ISO24751": {
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "control": {
                                "onscreenKeyboard": false
                            }
                        },
                        "metadata": [{
                            "type": "required",
                            "scope": ["control.*"]
                        }]
                    }
                }
            }
        }
    }
];

gpii.tests.preferencesServer.updatePreferencesSuccessSequence = [{
    func: "gpii.tests.dbOperation.invokePromiseProducer",
    args: ["{preferencesServer}.updatePreferences", ["{gpii.tests.preferencesServer.environment}.options.gpiiKey", "{gpii.tests.preferencesServer.environment}.options.preferences", "{gpii.tests.preferencesServer.environment}.options.view", "{gpii.tests.preferencesServer.environment}.options.mergePrefs"], "{that}"]
}, {
    listener: "gpii.tests.preferencesServer.verifyUpdateResponse",
    args: ["{gpii.tests.preferencesServer.environment}.options.gpiiKey", "{gpii.tests.preferencesServer.environment}.options.preferences", "{arguments}.0", "{gpii.tests.preferencesServer.environment}.options.view"],
    event: "{that}.events.onResponse"
}, {
    func: "gpii.tests.dbOperation.invokePromiseProducer",
    args: ["{preferencesServer}.preferencesService.getPrefsSafeByGpiiKey", ["{gpii.tests.preferencesServer.environment}.options.gpiiKey"], "{that}"]
}, {
    listener: "gpii.tests.preferencesServer.verifyRawPreferences",
    args: ["{gpii.tests.preferencesServer.environment}.options.expectedRaw", "{arguments}.0"],
    event: "{that}.events.onResponse"
}];

gpii.tests.preferencesServer.verifyUpdateResponse = function (gpiiKey, preferences, response) {
    var expected = {
        gpiiKey: gpiiKey,
        preferences: preferences
    };
    jqUnit.assertDeepEq("The response of updatePreferences() is expected", expected, response);
};

gpii.tests.preferencesServer.verifyRawPreferences = function (expectedRaw, response) {
    jqUnit.assertDeepEq("The saved raw preferences is expected", expectedRaw, response.prefsSafe.preferences);
};

// updatePreferences() error cases
gpii.tests.preferencesServer.updatePreferencesErrorFixtures = [
    {
        name: "updatePreferences(): return error if preferences is not provided",
        gpiiKey: "a-gpii-key",
        expectedMsg: gpii.preferencesServer.errors.missingPreferences
    },
    {
        name: "updatePreferences(): return error if a GPII key is not provided",
        preferences: {},
        expectedMsg: gpii.preferencesServer.errors.missingGpiiKey
    },
    {
        name: "updatePreferences(): return error if a GPII key is not found in the database",
        gpiiKey: "nonexistent-gpii-key",
        preferences: {},
        expectedMsg: "Cannot find the GPII key \"nonexistent-gpii-key\""
    }
];

gpii.tests.preferencesServer.updatePreferencesErrorSequence = [{
    func: "gpii.tests.dbOperation.invokePromiseProducer",
    args: ["{preferencesServer}.updatePreferences", ["{gpii.tests.preferencesServer.environment}.options.gpiiKey", "{gpii.tests.preferencesServer.environment}.options.preferences", "{gpii.tests.preferencesServer.environment}.options.view"], "{that}"]
}, {
    listener: "gpii.tests.preferencesServer.verifyError",
    args: ["{gpii.tests.preferencesServer.environment}.options.expectedMsg", "{arguments}.0"],
    event: "{that}.events.onError"
}];

// Shared utility Functions
gpii.tests.preferencesServer.verifyError = function (expectedMsg, response) {
    var expectedError = {"message": expectedMsg};
    jqUnit.assertDeepEq("The expected error message is received", expectedError, response);
};

gpii.tests.preferencesServer.runTestFixture([{
    name: "getPreferences(): success workflows",
    testFixtures: gpii.tests.preferencesServer.getPreferencesSuccessFixtures,
    sequence: gpii.tests.preferencesServer.getPreferencesSuccessSequence
}, {
    name: "getPreferences(): Retrieving preferences by a nonexistent GPII key returns an error",
    testFixtures: gpii.tests.preferencesServer.getPreferencesErrorFixtures,
    sequence: gpii.tests.preferencesServer.getPreferencesErrorSequence
}, {
    name: "createPreferences(): success workflows for creating preferences",
    testFixtures: gpii.tests.preferencesServer.createPreferencesSuccessFixtures,
    sequence: gpii.tests.preferencesServer.createPreferencesSuccessSequence
}, {
    name: "createPreferences(): error workflows for creating preferences",
    testFixtures: gpii.tests.preferencesServer.createPreferencesErrorFixtures,
    sequence: gpii.tests.preferencesServer.createPreferencesErrorSequence
}, {
    name: "updatePreferences(): success workflows for updating preferences",
    testFixtures: gpii.tests.preferencesServer.updatePreferencesSuccessFixtures,
    sequence: gpii.tests.preferencesServer.updatePreferencesSuccessSequence
}, {
    name: "updatePreferences(): error workflows for updating preferences",
    testFixtures: gpii.tests.preferencesServer.updatePreferencesErrorFixtures,
    sequence: gpii.tests.preferencesServer.updatePreferencesErrorSequence
}]);
