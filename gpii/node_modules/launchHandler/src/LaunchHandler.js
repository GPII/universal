/*!
Launch Handler

Copyright 2012 Raising the Floor - International

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

You may obtain a copy of the License at
https://github.com/gpii/universal/LICENSE.txt
*/
(function () {
    "use strict";

    var fluid = require("infusion"),
        child_process = require("child_process"),
        gpii = fluid.registerNamespace("gpii");
    
    fluid.defaults("gpii.launchHandler", {
        gradeNames: ["fluid.littleComponent", "autoInit"],
		preInitFunction: "gpii.launchHandler.preInit"
    });
    
    gpii.launchHandler.preInit = function (that) {
		that.set = function (directModel, data, callback) {
			var returnValue = fluid.invokeGlobalFunction(data.type, ["set", data.options]);
			callback(returnValue);
		}
		
		that.delete = function (directModel, data, callback) {
			var returnValue = fluid.invokeGlobalFunction(data.type, ["delete", data.options]);
			callback(returnValue);
		}
	}
	
	//data is an array: first entry is either "delete" or "set", second entry is an object
	gpii.launchHandler.exec = function (action, options) {
		//we want to kill an already running process:
		if (action == "delete") {
			//if we get a process id (pid) kill that process
			if (options.pid) {
				console.log(options);
				process.kill(options.pid);
			} else {
				//else fire the given command to kill the process
				process = child_process.spawn(options.command, options.args, options.options);
			}
			//TODO Error handling for both above cases
			return true;
		} else if (action == "set") {		
			var spawnedProcess = child_process.spawn(options.command, options.args, options.options);

			return { 
				//TODO: error handling?!
				statusCode: 200,
				pid: spawnedProcess.pid,
				process: spawnedProcess
			}
			
		}
	}
})();
