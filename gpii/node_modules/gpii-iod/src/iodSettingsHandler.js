/*
 * Install on Demand.
 *
 * Copyright 2018 Raising the Floor - International
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * The R&D leading to these results received funding from the
 * Department of Education - Grant H421A150005 (GPII-APCP). However,
 * these results do not necessarily represent the policy of the
 * Department of Education, and you should not assume endorsement by the
 * Federal Government.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";

var fluid = require("infusion");


var gpii = fluid.registerNamespace("gpii");
fluid.registerNamespace("gpii.iod.settingsHandler");

require("./packageInstaller.js");

gpii.iod.settingsHandler.getImpl = function () {
};
gpii.iod.settingsHandler.setImpl = function (payload) {

    var packages = fluid.transform(payload.options, function (value, key) {
        return Object.assign({}, value, payload.settings[key]);
    });

    var iod = fluid.queryIoCSelector(fluid.rootComponent, "gpii.iod")[0];

    var results = {};

    var packagePromises = [];

    fluid.each(Object.keys(packages), function (packageKey) {
        var packageRequest = packages[packageKey];

        // Check if it's already installed
        var packageInstalled = fluid.makeArray(packageRequest.isInstalled).every(function (isInstalled) {
            return fluid.invokeGradedFunction(isInstalled.type, isInstalled);
        });

        results[packageKey] = {
            oldValue: {
                installed: packageInstalled
            },
            newValue: {
            }
        };

        var p = fluid.promise();

        // For some reason the datasource.get call inside requirePackage doesn't resolve while it's inside this stack.
        // A better developer would have discovered why, but you have to make do with what you've got.
        process.nextTick(function () {
            if (packageInstalled) {
                p.resolve();
            } else {
                fluid.promise.follow(iod.requirePackage(packageRequest), p);
            }
        });

        p.then(function () {
            results[packageKey].newValue.installed = true;
        }, function (error) {
            fluid.log(error);
            results[packageKey].newValue.installed = false;
        });

        packagePromises.push(p);


    });

    return fluid.promise.sequence(packagePromises);
};

gpii.iod.settingsHandler.get = function (payload) {
    return gpii.settingsHandlers.invokeSettingsHandler(gpii.iod.settingsHandler.getImpl, payload);
};

gpii.iod.settingsHandler.set = function (payload) {
    return gpii.settingsHandlers.invokeSettingsHandler(gpii.iod.settingsHandler.setImpl, payload);

};
