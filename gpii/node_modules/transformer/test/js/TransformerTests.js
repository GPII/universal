/*!
GPII Settings Transformer Tests

Copyright 2012 OCAD University
Copyright 2013-2014 Raising the Floor

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

The research leading to these results has received funding from the European Union's
Seventh Framework Programme (FP7/2007-2013) under grant agreement no. 289016.

You may obtain a copy of the License at
https://github.com/GPII/universal/blob/master/LICENSE.txt
*/

/*global jqUnit */

"use strict";

var fluid = fluid || require("infusion"),
    gpii = fluid.registerNamespace("gpii");

fluid.setLogging(true);

(function () {
    fluid.registerNamespace("gpii.tests.transformer");

    var testSolutionsEntry = {
        "com.microsoft.windows.magnifier": {
            "name": "Windows Built-in Screen Magnifier",
            "contexts": {
                "OS": [
                    {
                        "id": "win32",
                        "version": ">=5.0"
                    }
                ]
            },
            "settingsHandlers": {
                "conf": {
                    "type": "gpii.windows.registrySettingsHandler.set",
                    "options": {
                        "hKey": "HKEY_CURRENT_USER",
                        "path": "Software\\Microsoft\\ScreenMagnifier",
                        "dataTypes": {
                            "Magnification": "REG_DWORD",
                            "Invert": "REG_DWORD",
                            "FollowFocus": "REG_DWORD",
                            "FollowCaret": "REG_DWORD",
                            "FollowMouse": "REG_DWORD",
                            "MagnificationMode": "REG_DWORD",
                            "ZoomIncrement": "REG_DWORD"
                        }
                    },
                    "capabilities": [],
                    "capabilitiesTransformations": {
                        "Invert": "http://registry\\.gpii\\.net/common/invertColours",
                        "Magnification": {
                            "transform": {
                                "type": "fluid.transforms.round",
                                "input": {
                                    "transform": {
                                        "type": "fluid.transforms.linearScale",
                                        "inputPath": "http://registry\\.gpii\\.net/common/magnification",
                                        "factor": 100
                                    }
                                }
                            }
                        },
                        "transform": [
                            {
                                "type": "fluid.transforms.arrayToSetMembership",
                                "inputPath": "http://registry\\.gpii\\.net/common/tracking",
                                "outputPath": "",
                                "presentValue": 1,
                                "missingValue": 0,
                                "options": {
                                    "focus": "FollowFocus",
                                    "caret": "FollowCaret",
                                    "mouse": "FollowMouse"
                                }
                            }
                        ],
                        "MagnificationMode": {
                            "transform": {
                                "type": "fluid.transforms.valueMapper",
                                "defaultInputPath": "http://registry\\.gpii\\.net/common/magnifierPosition",
                                "match": {
                                    "FullScreen": 2,
                                    "Lens": 3,
                                    "LeftHalf": 1,
                                    "RightHalf": 1,
                                    "TopHalf": 1,
                                    "BottomHalf": 1,
                                    "Custom": 2
                                }
                            }
                        }
                    }
                }
            },
            "configure": [
                "settings.conf"
            ],
            "restore": [
                "settings.conf"
            ],
            "start": [
                {
                    "type": "gpii.launch.exec",
                    "command": "${{environment}.SystemRoot}\\System32\\Magnify.exe"
                }
            ],
            "stop": [
                {
                    "type": "gpii.launch.exec",
                    "command": "${{environment}.SystemRoot}\\System32\\taskkill.exe /f /im Magnify.exe"
                }
            ]
        },

        "eu.singularlogic.pixelsense.sociable": {
            "name": "Sociable",
            "contexts": {
                "OS": [
                    {
                        "id": "win32",
                        "version": ">=5.0"
                    }
                ]
            },
            "settingsHandlers": {
                "myconf": {
                    "type": "gpii.settingsHandlers.XMLHandler.set",
                    "options": {
                        "filename": "C:\\Sociable\\Configuration.xml",
                        "encoding": "utf-8",
                        "xml-tag": "<?xml version=\"1.0\"?>"
                    },
                    "capabilities": [],
                    "capabilitiesTransformations": {
                        "user.$t": {
                            "literalValue": 1
                        },
                        "expert.$t": {
                            "literalValue": 1
                        },
                        "careCenter.$t": {
                            "literalValue": 1
                        },
                        "screenReaderTTSEnabled": {
                            "value": "http://registry\\.gpii\\.net/common/screenReaderTTSEnabled"
                        },
                        "highContrastEnabled": {
                            "value": "http://registry\\.gpii\\.net/common/highContrastEnabled"
                        },
                        "fontSize": {
                            "value": {
                                "transform": {
                                    "type": "fluid.transforms.quantize",
                                    "inputPath": "http://registry\\.gpii\\.net/common/fontSize",
                                    "ranges": [
                                        {
                                            "upperBound": 14,
                                            "output": "normal"
                                        },
                                        {
                                            "output": "large"
                                        }
                                    ]
                                }
                            }
                        }
                    }
                }
            },
            "configure": [
                "settings.myconf"
            ],
            "restore": [
                "settings.myconf"
            ],
            "start": [
                {
                    "type": "gpii.launch.exec",
                    "command": "C:\\Sociable\\Cloud4All.exe"
                }
            ],
            "stop": [
                {
                    "type": "gpii.launch.exec",
                    "command": "C:\\Sociable\\Cloud4All.exe -stop"
                }
            ]
        }
    };

    var testFixtures = [
        {
            name: "Application specific settings for the same application",
            input: {
                "applications": {
                    "com.microsoft.windows.magnifier": {
                        "active": true,
                        "settings": {
                            "http://registry.gpii.net/applications/com.microsoft.windows.magnifier": {
                                "FollowFocus": 0,
                                "FollowCaret": 1,
                                "FollowMouse": 1,
                                "Invert": false
                            }
                        }
                    }
                }
            },
            expected: {
                "com.microsoft.windows.magnifier": {
                    "active": true,
                    "name": testSolutionsEntry["com.microsoft.windows.magnifier"].name,
                    "start": testSolutionsEntry["com.microsoft.windows.magnifier"].start,
                    "stop": testSolutionsEntry["com.microsoft.windows.magnifier"].stop,
                    "configure": testSolutionsEntry["com.microsoft.windows.magnifier"].configure,
                    "restore": testSolutionsEntry["com.microsoft.windows.magnifier"].restore,
                    "settingsHandlers": {
                        "conf": {
                            "type": "gpii.windows.registrySettingsHandler.set",
                            "options": {
                                "dataTypes": {
                                    "FollowCaret": "REG_DWORD",
                                    "FollowFocus": "REG_DWORD",
                                    "FollowMouse": "REG_DWORD",
                                    "Invert": "REG_DWORD",
                                    "Magnification": "REG_DWORD",
                                    "MagnificationMode": "REG_DWORD",
                                    "ZoomIncrement": "REG_DWORD"
                                },
                                "hKey": "HKEY_CURRENT_USER",
                                "path": "Software\\Microsoft\\ScreenMagnifier"
                            },
                            "settings": {
                                "FollowCaret": 1,
                                "FollowFocus": 0,
                                "FollowMouse": 1,
                                "Invert": false
                            }
                        }
                    }
                }
            }
        }, {
            name: "Common terms only",
            input: {
                "applications": {
                    "com.microsoft.windows.magnifier": {
                        "active": true,
                        "settings": {
                            "http://registry.gpii.net/common/tracking": [ "mouse", "caret" ]
                        }
                    }
                }
            },
            expected: {
                "com.microsoft.windows.magnifier": {
                    "active": true,
                    "name": testSolutionsEntry["com.microsoft.windows.magnifier"].name,
                    "start": testSolutionsEntry["com.microsoft.windows.magnifier"].start,
                    "stop": testSolutionsEntry["com.microsoft.windows.magnifier"].stop,
                    "configure": testSolutionsEntry["com.microsoft.windows.magnifier"].configure,
                    "restore": testSolutionsEntry["com.microsoft.windows.magnifier"].restore,
                    "settingsHandlers": {
                        "conf": {
                            "type": "gpii.windows.registrySettingsHandler.set",
                            "options": {
                                "dataTypes": {
                                    "FollowCaret": "REG_DWORD",
                                    "FollowFocus": "REG_DWORD",
                                    "FollowMouse": "REG_DWORD",
                                    "Invert": "REG_DWORD",
                                    "Magnification": "REG_DWORD",
                                    "MagnificationMode": "REG_DWORD",
                                    "ZoomIncrement": "REG_DWORD"
                                },
                                "hKey": "HKEY_CURRENT_USER",
                                "path": "Software\\Microsoft\\ScreenMagnifier"
                            },
                            "settings": {
                                "FollowCaret": 1,
                                "FollowFocus": 0,
                                "FollowMouse": 1
                            }
                        }
                    }
                }
            }
        }, {
            name: "App specific overwrites common terms",
            input: {
                "applications": {
                    "com.microsoft.windows.magnifier": {
                        "active": true,
                        "settings": {
                            "http://registry.gpii.net/applications/com.microsoft.windows.magnifier": {
                                "FollowFocus": 0,
                                "Invert": false
                            },
                            "http://registry.gpii.net/common/invertColours": false
                        }
                    }
                }
            },
            expected: {
                "com.microsoft.windows.magnifier": {
                    "active": true,
                    "name": testSolutionsEntry["com.microsoft.windows.magnifier"].name,
                    "start": testSolutionsEntry["com.microsoft.windows.magnifier"].start,
                    "stop": testSolutionsEntry["com.microsoft.windows.magnifier"].stop,
                    "configure": testSolutionsEntry["com.microsoft.windows.magnifier"].configure,
                    "restore": testSolutionsEntry["com.microsoft.windows.magnifier"].restore,
                    "settingsHandlers": {
                        "conf": {
                            "type": "gpii.windows.registrySettingsHandler.set",
                            "options": {
                                "dataTypes": {
                                    "FollowCaret": "REG_DWORD",
                                    "FollowFocus": "REG_DWORD",
                                    "FollowMouse": "REG_DWORD",
                                    "Invert": "REG_DWORD",
                                    "Magnification": "REG_DWORD",
                                    "MagnificationMode": "REG_DWORD",
                                    "ZoomIncrement": "REG_DWORD"
                                },
                                "hKey": "HKEY_CURRENT_USER",
                                "path": "Software\\Microsoft\\ScreenMagnifier"
                            },
                            "settings": {
                                "Invert": false,
                                "FollowFocus": 0
                            }
                        }
                    }
                }
            }
        }, {
            name: "Irelevant App specific settings are ignored",
            input: {
                "applications": {
                    "com.microsoft.windows.magnifier": {
                        "active": true,
                        "settings": {
                            "http://registry.gpii.net/applications/some.app": {
                                "settingA": 0
                            },
                            "http://registry.gpii.net/common/invertColours": false
                        }
                    }
                }
            },
            expected: {
                "com.microsoft.windows.magnifier": {
                    "active": true,
                    "name": testSolutionsEntry["com.microsoft.windows.magnifier"].name,
                    "start": testSolutionsEntry["com.microsoft.windows.magnifier"].start,
                    "stop": testSolutionsEntry["com.microsoft.windows.magnifier"].stop,
                    "configure": testSolutionsEntry["com.microsoft.windows.magnifier"].configure,
                    "restore": testSolutionsEntry["com.microsoft.windows.magnifier"].restore,
                    "settingsHandlers": {
                        "conf": {
                            "type": "gpii.windows.registrySettingsHandler.set",
                            "options": {
                                "dataTypes": {
                                    "FollowCaret": "REG_DWORD",
                                    "FollowFocus": "REG_DWORD",
                                    "FollowMouse": "REG_DWORD",
                                    "Invert": "REG_DWORD",
                                    "Magnification": "REG_DWORD",
                                    "MagnificationMode": "REG_DWORD",
                                    "ZoomIncrement": "REG_DWORD"
                                },
                                "hKey": "HKEY_CURRENT_USER",
                                "path": "Software\\Microsoft\\ScreenMagnifier"
                            },
                            "settings": {
                                "Invert": false
                            }
                        }
                    }
                }
            }
        }, {
            name: "multi applications blocks",
            input: {
                "applications": {
                    "com.microsoft.windows.magnifier": {
                        "active": true,
                        "settings": {
                            "http://registry.gpii.net/applications/com.microsoft.windows.magnifier": {
                                "Invert": false
                            }
                        }
                    },
                    "eu.singularlogic.pixelsense.sociable": {
                        "active": true,
                        "settings": {
                            "http://registry.gpii.net/common/fontSize": 12
                        }
                    }
                }
            },
            expected: {
                "com.microsoft.windows.magnifier": {
                    "active": true,
                    "name": testSolutionsEntry["com.microsoft.windows.magnifier"].name,
                    "start": testSolutionsEntry["com.microsoft.windows.magnifier"].start,
                    "stop": testSolutionsEntry["com.microsoft.windows.magnifier"].stop,
                    "configure": testSolutionsEntry["com.microsoft.windows.magnifier"].configure,
                    "restore": testSolutionsEntry["com.microsoft.windows.magnifier"].restore,
                    "settingsHandlers": {
                        "conf": {
                            "type": "gpii.windows.registrySettingsHandler.set",
                            "options": {
                                "dataTypes": {
                                    "FollowCaret": "REG_DWORD",
                                    "FollowFocus": "REG_DWORD",
                                    "FollowMouse": "REG_DWORD",
                                    "Invert": "REG_DWORD",
                                    "Magnification": "REG_DWORD",
                                    "MagnificationMode": "REG_DWORD",
                                    "ZoomIncrement": "REG_DWORD"
                                },
                                "hKey": "HKEY_CURRENT_USER",
                                "path": "Software\\Microsoft\\ScreenMagnifier"
                            },
                            "settings": {
                                "Invert": false
                            }
                        }
                    }
                },
                "eu.singularlogic.pixelsense.sociable": {
                    "active": true,
                    "name": testSolutionsEntry["eu.singularlogic.pixelsense.sociable"].name,
                    "start": testSolutionsEntry["eu.singularlogic.pixelsense.sociable"].start,
                    "stop": testSolutionsEntry["eu.singularlogic.pixelsense.sociable"].stop,
                    "configure": testSolutionsEntry["eu.singularlogic.pixelsense.sociable"].configure,
                    "restore": testSolutionsEntry["eu.singularlogic.pixelsense.sociable"].restore,
                    "settingsHandlers": {
                        "myconf": {
                            "type": "gpii.settingsHandlers.XMLHandler.set",
                            "options": {
                                "filename": "C:\\Sociable\\Configuration.xml",
                                "encoding": "utf-8",
                                "xml-tag": "<?xml version=\"1.0\"?>"
                            },
                            "settings": {
                                "fontSize": {
                                    "value": "normal"
                                },
                                "careCenter": {
                                    "$t": 1
                                },
                                "expert": {
                                    "$t": 1
                                },
                                "user": {
                                    "$t": 1
                                }
                            }
                        }
                    }
                }
            }
        }, {
            name: "Application specific settings for non-existing solution",
            input: {
                "applications": {
                    "com.microsoft.windows.bogus-app": {
                        "active": true,
                        "settings": {
                            "http://registry.gpii.net/applications/com.microsoft.windows.bogus-app": {
                                "FollowFocus": 0,
                                "FollowCaret": 1,
                                "FollowMouse": 1,
                                "Invert": false
                            }
                        }
                    }
                }
            },
            expected: {}
        }
    ];

    jqUnit.module("Tester");
    jqUnit.test("Transformation tests", function () {
        fluid.each(testFixtures, function (test) {
            var result = gpii.transformer.configurationToSettings(test.input, testSolutionsEntry);
            jqUnit.assertDeepEq(test.name, test.expected, result);
        });
    });

    /* --------------- gpii.transformer.timeInRange tests -------------------- */
    gpii.tests.transformer.timeInRangeTests = {
        rules: {
            normalOrder: {
                "foo": {
                    "transform": {
                        "type": "gpii.transformer.timeInRange",
                        "inputPath": "bar",
                        "from": "10:30",
                        "to": "19:45"
                    }
                }
            },
            normalOrderMinutes: {
                "foo": {
                    "transform": {
                        "type": "gpii.transformer.timeInRange",
                        "inputPath": "bar",
                        "from": "10:30",
                        "to": "10:59"
                    }
                }
            },
            wrappedOrder: {
                "foo": {
                    "transform": {
                        "type": "gpii.transformer.timeInRange",
                        "inputPath": "bar",
                        "from": "22:15",
                        "to": "00:18"
                    }
                }
            }
        },
        expects: {
            "Basic hours - matches": {
                rule: "normalOrder",
                input: {
                    bar: "11:00"
                },
                expected: {
                    foo: true
                }
            },
            "Basic hours - above threshold": {
                rule: "normalOrder",
                input: {
                    bar: "19:47"
                },
                expected: {
                    foo: false
                }
            },
            "Basic hours - below threshold": {
                rule: "normalOrder",
                input: {
                    bar: "10:28"
                },
                expected: {
                    foo: false
                }
            },
            "Minutes windows - matches": {
                rule: "normalOrderMinutes",
                input: {
                    bar: "10:37"
                },
                expected: {
                    foo: true
                }
            },
            "Wrapped order - matches morning": {
                rule: "wrappedOrder",
                input: {
                    bar: "00:12"
                },
                expected: {
                    foo: true
                }
            },
            "Wrapped order - matches evening": {
                rule: "wrappedOrder",
                input: {
                    bar: "23:00"
                },
                expected: {
                    foo: true
                }
            },
            "Wrapped hours - above threshold": {
                rule: "wrappedOrder",
                input: {
                    bar: "10:28"
                },
                expected: {
                    foo: false
                }
            }
        }
    };

    jqUnit.test("gpii.transformer.timeInRange tests", function () {
        fluid.each(gpii.tests.transformer.timeInRangeTests.expects, function (test, tname) {
            var transformed = fluid.model.transformWithRules(test.input, gpii.tests.transformer.timeInRangeTests.rules[test.rule]);
            jqUnit.assertDeepEq("timeInRange transformation tests - " + tname, test.expected, transformed);
        });
    });

})();
