/*!
GPII Settings Transformer Tests

Copyright 2012 OCAD University

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

You may obtain a copy of the License at
https://github.com/gpii/universal/LICENSE.txt
*/

(function () {
    fluid.registerNamespace("gpii.tests.transformer");

    var appSpecificPreferences = {
        "display": {
            "screenEnhancement": {
                "applications": {
                    "org.gnome.desktop.a11y.magnifier": {
                        "name": "GNOME Shell Magnifier",
                        "priority": 100,
                        "parameters": {
                            "show-cross-hairs": true
                        }
                    }
                }
            }
        }
    };
    
    var gnomeMagnifierLaunchHandlers = [
        {
            "type": "gpii.launch.gsettings",
            "start": {
                "schema": "org.gnome.desktop.a11y.applications",
                "key": "screen-magnifier-enabled",
                "value": true
            },
            "stop": {
                "schema": "org.gnome.desktop.a11y.applications",
                "key": "screen-magnifier-enabled",
                "value": false
            }
        }
    ];
    
    var gnomeMagnifierSolutionSpec = {
        "id": "org.gnome.desktop.a11y.magnifier",
        "settingsHandlers": [
            {
                "type": "gpii.gsettings.set",
                "capabilities": {
                    "screenEnhancement": {
                        "magnification": {
                            "path": "mag-factor",
                            "type": "gpii.transform.scale",
                            "options": {
                                "factor": 100
                            }
                        }
                    }
                },
                "options": {}
            }
        ],
        "launchHandlers": gnomeMagnifierLaunchHandlers
    };
    
    var expectedAppSpecificPreferences = [
        {
            "id": "org.gnome.desktop.a11y.magnifier",
            "settingsHandlers": [
                {
                    "type": "gpii.gsettings.set",
                    "settings": {
                         "show-cross-hairs": true
                    },
                    "options": {}
                }
            ],
            "launchHandlers": gnomeMagnifierLaunchHandlers
        }
    ];
    
    var genericPreferences = {
        "display": {
            "screenEnhancement": {
                "magnification": 2.0,
                "tracking": "mouse"
            }
        }
    };
    
    // TODO: Once ModelTransformation has been correctly implemented in the Transformer, 
    // this payload will need to be updated to contain actual, correct output.
    // It's here to test that the basic no-transform implementation is working correctly.
    var expectedGenericSettingsNoTransformation = [
        {
            "id": "org.gnome.desktop.a11y.magnifier",
            "settingsHandlers": [
                {
                    "type": "gpii.gsettings.set",
                    "settings": {},
                    "options": {}
                }
            ],
            "launchHandlers": gnomeMagnifierLaunchHandlers
        }
    ];
    
    var genericAndAppSpecificTransformerPayload = {
        "preferences": {
            "display": {
                "screenEnhancement": {
                    "magnification": 2.0,
                    "tracking": "mouse",
                    "applications": {
                        "org.gnome.desktop.a11y.magnifier": {
                            "name": "GNOME Shell Magnifier",
                           "priority": 100,
                           "parameters": {
                               "show-cross-hairs": true
                           }
                        }
                    }
                }
            }
        },

        "solutions": [gnomeMagnifierSolutionSpec]
    };
    
    var expectedGenericAndAppSpecificSettings = [
        {
            "id": "org.gnome.desktop.a11y.magnifier",
            "settingsHandlers": [
                {
                    "type": "gpii.gsettings.set",
                    "settings": {
                        "mag-factor": 200,
                        "mouse-tracking": "centered",
                        "show-cross-hairs": true
                    },
                    "options": {}
                }
            ],
            "launchHandlers": gnomeMagnifierLaunchHandlers
        }
    ];
    
    // TODO: This payload only exists to assert the basic no-transform implementation.
    // Once ModelTransformation has been correctly implemented in the Transformer, 
    // this should be replaced with tests against "expectedGenericAndAppSpecificSettings" instead.
    var expectedGenericAndAppSpecificSettingsNoTransformation = [
        {
            "id": "org.gnome.desktop.a11y.magnifier",
            "settingsHandlers": [
                {
                    "type": "gpii.gsettings.set",
                    "settings": {
                        "show-cross-hairs": true
                    },
                    "options": {}
                }
            ],
            "launchHandlers": gnomeMagnifierLaunchHandlers
        }
    ];
    
    var transformationConfigs = [
        {
            name: "only application specific preferences.",
            input: {
                "preferences": appSpecificPreferences,
                "solutions": [gnomeMagnifierSolutionSpec]
            },
            
            expectedOutput: expectedAppSpecificPreferences
        },
        {
            name: "only generic preferences.",
            input: {
                "preferences": genericPreferences,
                "solutions": [gnomeMagnifierSolutionSpec]
            },
            
            expectedOutput: expectedGenericSettingsNoTransformation
        },
        {
            name: "mix of generic and application-specific preferences.",
            input: genericAndAppSpecificTransformerPayload,
            expectedOutput: expectedGenericAndAppSpecificSettingsNoTransformation
        }
    ];
    
    
    var testTransformation = function (input, expectedOutput) {
        var transformer = gpii.transformer();
        var actual = transformer.transformSettings(input);
        jqUnit.expect(1);
        jqUnit.assertDeepEq("The input preferences should be transformed into a valid application-specific settingsHandler block.",
            expectedOutput, actual);
    };
        
    var testTransformationConfig = function (testCase, config) {
        testCase.test("gpii.transformer.transformSettings(), " + config.name, function () {
            testTransformation(config.input, config.expectedOutput);
        });
    };
    
    gpii.tests.transformer.runTests = function () {
        var testCase = jqUnit.TestCase("Settings Transformer");

        testCase.test("gpii.transformer.findApplications()", function () {
            var expected = fluid.get(genericAndAppSpecificTransformerPayload, "preferences.display.screenEnhancement.applications");
            var actual = gpii.transformer.findApplications(genericAndAppSpecificTransformerPayload.preferences);
            jqUnit.assertDeepEq("", expected, actual);
        });

        
        for (var i = 0; i < transformationConfigs.length; i++) {
            var config = transformationConfigs[i];
            testTransformationConfig(testCase, config);
        }
    };

}());
