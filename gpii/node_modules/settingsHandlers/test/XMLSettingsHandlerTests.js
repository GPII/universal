/*!
XML Settings Handler Tests

Copyright 2012 Raising the Floor - International

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

You may obtain a copy of the License at
https://github.com/gpii/universal/LICENSE.txt
*/

/*global require, __dirname*/

(function () {
    // This loads universal.
     var fluid = require("universal"),
         gpii = fluid.registerNamespace("gpii"),
         jqUnit = fluid.require("jqUnit"),
         fs = require("fs");

    fluid.require("settingsHandlers", require);

    var XMLHandlerTester = gpii.tests.testEnvironment();

    XMLHandlerTester.test("XMLHandler.applySettings", function () {
        //check simple json structure
        var result = gpii.settingsHandlers.XMLHandler.applySettings({ "key": "val1" }, { "key": "val2"});
        jqUnit.assertDeepEq("Simple setting", { key: { oldValue: 'val2', newValue: 'val1' } }, result);

        //complex json structure
        var json = {
            firstentry: {
                lvl2: {
                    key1: "vala",
                    key2: "valb"
                }
            },
            nextentry: {
                key3: "valc"
            }
        };
        var settings = {
            "firstentry.lvl2.key1": "newValue",
            "nextentry.key3": "otherNewValue"
        };
        var exp = {
            "firstentry.lvl2.key1": { oldValue: "vala", newValue: "newValue" },
            "nextentry.key3": { oldValue: "valc", newValue: "otherNewValue" }
        };
        result = gpii.settingsHandlers.XMLHandler.applySettings(settings, json);
        jqUnit.assertDeepEq("Multiple and nested settings", exp, result);

        //check applySettings for unset values
        json = {
            somekey: {
                somekey2: {
                    key1: "vala"
                }
            }
        };
        settings = {
            "newkey1.newkey2": "someval"
        };
        exp = { 'newkey1.newkey2': { oldValue: undefined, newValue: 'someval' }};
        result = gpii.settingsHandlers.XMLHandler.applySettings(settings, json);
        jqUnit.assertDeepEq("Non existing settings (multilevel)", exp, result);
    });

    XMLHandlerTester.test("XMLHandler.set", function () {
        var payload = {
            "com.texthelp.readwritegold": [{
                settings: {
                    "ApplicationSettings.IsEnterprise.$t": true,
                    "ApplicationSettings.SpeechInput.LanguageId.$t": 1
                },
                options: {
                    "filename": __dirname+"/data/XMLSettingsHandler/input1.xml",
                    "encoding": "utf-8",
                    "xml-tag": "<?xml version=\"1.0\" encoding=\"utf-8\"?>"
                }
            }]
        };
        var expectedResult = {
            'com.texthelp.readwritegold': [{
                settings: {
                    'ApplicationSettings.IsEnterprise.$t': { oldValue: 'false', newValue: true },
                    'ApplicationSettings.SpeechInput.LanguageId.$t': { oldValue: '0', newValue: 1 }
                },
                options: {
                    "filename": __dirname+"/data/XMLSettingsHandler/input1.xml",
                    "encoding": "utf-8",
                    "xml-tag": "<?xml version=\"1.0\" encoding=\"utf-8\"?>"
                }
            }]

        };
        //read original XML and copy to a file we can mess up:
        var origXML = fs.readFileSync(__dirname+"/data/XMLSettingsHandler/data1.xml", "utf-8");
        fs.writeFileSync(__dirname+"/data/XMLSettingsHandler/input1.xml", origXML, "utf-8");
        //test return payload
        var returnPayload = gpii.settingsHandlers.XMLHandler.set(payload);
        jqUnit.assertDeepEq("Checking return payload for simple XML file: ", expectedResult, returnPayload);
        
        //next check that the written XML file is as expected:
        var savedXML = fs.readFileSync(__dirname+"/data/XMLSettingsHandler/input1.xml", "utf-8");
        var expectedXML = fs.readFileSync(__dirname+"/data/XMLSettingsHandler/expected_output1.xml", "utf-8");
        jqUnit.assertEquals("checking XML file: ", expectedXML, savedXML);
    });
}());