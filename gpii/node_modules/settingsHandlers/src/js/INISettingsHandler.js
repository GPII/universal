/*!
  GPII INI Settings Handler

  Copyright 2012 Raising the Floor - International

  Licensed under the New BSD license. You may not use this file except in
  compliance with this License.

  You may obtain a copy of the License at
  https://github.com/gpii/universal/LICENSE.txt
*/

/*global require*/

(function () {

    "use strict";

    var fluid = require("infusion"),
        fs = require("fs"),
        gpii = fluid.registerNamespace("gpii"),
        iniparser = require("ini");

    fluid.registerNamespace("gpii.settingsHandlers.INISettingsHandler");

    // TODO: When FLUID-4852 is fixed, remove these definitions
    var getParser = {
        parser: {
            parse: fluid.pathUtil.parseEL,
            compose: fluid.pathUtil.composePath
        },
        strategies: [fluid.model.defaultFetchStrategy]
    };

    var setParser = {
        parser: {
            parse: fluid.pathUtil.parseEL,
            compose: fluid.pathUtil.composePath
        },
        strategies: [fluid.model.defaultFetchStrategy, fluid.model.defaultCreatorStrategy]
    };

    gpii.settingsHandlers.INISettingsHandler.set = function (profile) {
        var returnObj = fluid.copy(profile);
        return fluid.transform(returnObj, function (solution) {
            return fluid.transform(solution, function(solutionEntry) {
                var options = solutionEntry.options;
                var userRequestedSettings = solutionEntry.settings;
                var newSettingsResponse,
                    oldValue;
                    
                if (options && options.path) {
                    var defaultSettings = iniparser.parse(fs.readFileSync(options.path, 'utf-8'), options);
                    newSettingsResponse = {};
                    // record differences between required and default settings
                    // so that they default settings can be restored
                    fluid.each(userRequestedSettings, function (settingVal, settingKey) {
                        oldValue = fluid.get(defaultSettings, settingKey, getParser);
                        fluid.set(defaultSettings, settingKey, settingVal, setParser);
                        newSettingsResponse[settingKey] = {
                            "oldValue": oldValue,
                            "newValue": settingVal
                        };
                    });
                    solutionEntry.settings = defaultSettings;

                    // Write the new settings to a file for the application to read
                    var iniOutput = iniparser.stringify(defaultSettings, null, options);
                    fs.writeFileSync(options.path, iniOutput);
                    fluid.log("Settings explicitly configured in GPII profile:", iniOutput);
                    return { options: options, settings: newSettingsResponse };
                }
                return solutionEntry;
            });  
        });
    };
}());