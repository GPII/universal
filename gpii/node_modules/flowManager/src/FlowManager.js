/*
 * GPII Flow Manager
 *
 * Copyright 2012 OCAD University
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * The research leading to these results has received funding from the European Union's
 * Seventh Framework Programme (FP7/2007-2013)
 * under grant agreement no. 289016.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";

var fluid = require("infusion"),
    gpii = fluid.registerNamespace("gpii");

require("kettle");

require("./UserLogonStateChange.js");
require("./UserSave.js");
require("./GetUserToken.js");
require("./UserUpdate.js");
require("./BrowserChannel.js");
require("./CloudBasedFlowManager.js"); // TODO: move this include to be operated by a config
require("./UntrustedFlowManager.js");

require("lifecycleManager");
require("transformer");

fluid.defaults("gpii.flowManager", {
    gradeNames: ["kettle.app"],
    urls: {
        preferences: "",
        deviceReporter: "",
        solutionsReporter: ""
    },
    matchMakers: {},
    solutionsRegistryUrl: "",
    components: {
        solutionsRegistryDataSource: {
            type: "kettle.dataSource.URL",
            options: {
                url: "{gpii.flowManager}.options.urls.solutionsRegistry",
                termMap: {
                    "os": "os",
                    "version": "version"
                }
            }
        },
        preferencesDataSource: {
            type: "kettle.dataSource.URL",
            options: {
                url: "{gpii.flowManager}.options.urls.preferences",
                termMap: {
                    userToken: "userToken"
                }
            }
        },
        deviceReporterDataSource: {
            type: "kettle.dataSource.URL",
            options: {
                url: "{gpii.flowManager}.options.urls.deviceReporter"
            }
        },
        lifecycleManager: {
            type: "gpii.lifecycleManager"
        },
        transformer: {
            type: "gpii.transformer"
        },
        matchMakerFramework: {
            type: "gpii.matchMakerFramework"
        },
        browserChannel: {
            type: "gpii.flowManager.browserChannel"
        }
    },
    requestHandlers: {
        userLogin: {
            route: "/user/:userToken/login",
            method: "get",
            handler: "gpii.flowManager.userLogin.handler"
        },
        userLogout: {
            route: "/user/:userToken/logout",
            method: "get",
            handler: "gpii.flowManager.userLogout.handler"
        },
        userLogonStateChange: {
            route: "/user/:userToken/logonChange",
            method: "get",
            handler: "gpii.flowManager.userLogonStateChange.handler"
        },
        getUserToken: {
            route: "/userToken",
            method: "get",
            handler: "gpii.flowManager.getUserToken.handler"
        }
    }
});



// Mixin grades for the FlowManager

fluid.defaults("gpii.flowManager.save", {
    requestHandlers: {
        userSavePost: {
            route: "/user/preferences",
            method: "post",
            handler: "gpii.flowManager.userSave.handler"
        },
        userSavePut: {
            route: "/user/preferences/:userToken",
            method: "put",
            handler: "gpii.flowManager.userSave.handler"
        }
    },
    distributeOptions: {
        record: {
            writable: true,
            writeMethod: "POST"
        },
        target: "{that > preferencesDataSource}.options"
    }
});


fluid.defaults("gpii.flowManager.ws", {
    requestHandlers: {
        userUpdate: {
            route: "/update",
            handler: "gpii.flowManager.userUpdate.handler"
        },
        browserChannel: {
            route: "/browserChannel",
            handler: "gpii.flowManager.browserChannel.handler"
        }
    },
    components: {
        webSocketsComponent: {
            type: "gpii.settingsHandlers.webSocketsComponent"
        }
    },
    listeners: {
        onCreate: {
            funcName: "gpii.flowManager.mountWebSocketsSettingsHandler",
            args: ["{webSocketsComponent}"]
        }
    }
});


gpii.flowManager.mountWebSocketsSettingsHandler = function (webSocketsComponent) {
    gpii.settingsHandlers.webSockets = webSocketsComponent;
};

