/*!
GPII Full SHA Revision DataSource

Copyright 2020 OCAD University

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

You may obtain a copy of the License at
https://github.com/GPII/universal/blob/master/LICENSE.txt
*/

"use strict";

var fluid = require("infusion"),
    gpii = fluid.registerNamespace("gpii");

require("kettle");

fluid.registerNamespace("gpii.revisionRequester");

fluid.defaults("gpii.revisionRequester", {
    gradeNames: ["fluid.component"],

    // Prepend CBFM host/port distributed down from, e.g., gpii.flowManager.config.untrusted
    url: "/revision",
    components: {
        gpiiRevisionDataSource: {
            type: "kettle.dataSource.URL",
            options: {
                url: "{revisionRequester}.options.url"
            }
        }
    },
    invokers: {
        getRevision: {
            funcName: "gpii.revisionRequester.getRevision",
            args: ["{that}"]
        }
    }
});

gpii.revisionRequester.getRevision = function (that) {
    var togo = fluid.promise();
    
    var revisionPromise = that.gpiiRevisionDataSource.get();
    revisionPromise.then(function (revision) {
        fluid.promise.follow(revisionPromise, togo);
    }, function (err) {
        togo.resolve(err)
    });
    return togo;
};
