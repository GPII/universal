/*!
GPII User Login Component

Copyright 2012 OCAD University

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

You may obtain a copy of the License at
https://github.com/gpii/universal/LICENSE.txt
*/

(function () {

    "use strict";

    var fluid = require("infusion"),
        uuid = require("node-uuid"),
        kettle = fluid.require("kettle", require);

    kettle.requests.request.handler.userLoginPreInit = function (that) {
        that.getPreferences = function (token) {
            that.preferencesDataSource.get({
                token: token
            }, function (preferences) {
                fluid.log("Fetched user preferences: ", preferences);
                that.events.onPreferences.fire(preferences);
            });
        };
        that.getDevice = function () {
            that.deviceReporterDataSource.get(null, function (device) {
                fluid.log("Fetched device reporter data: ", device);
                that.events.onDevice.fire(device);
            });
        };
        that.onReadyToMatchHandler = function (preferences, device) {
            that.matchMakerDataSource.set(null, {
                preferences: preferences,
                device: device
            }, function (match) {
                fluid.log("Matched preferences and device reporter data: ", match);
                that.events.onMatch.fire(match);
            });
        };
        that.onMatchHandler = function (match) {
            that.lifecycleManager.start({userToken: that.userToken}, match, function (response) {
                fluid.log("Lifecycle manager returned: ", response);
                that.requestProxy.events.onSuccess.fire("User with token " + that.userToken + " was successfully logged in.");
            });
        };
    };

    kettle.requests.request.handler.userLogin = function (token, handler) {
        handler.userToken = token;
        handler.events.onUserListener.fire(token);
    };

})();