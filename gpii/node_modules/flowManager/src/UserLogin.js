/*!
GPII User Login Component

Copyright 2012 OCAD University

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

You may obtain a copy of the License at
https://github.com/gpii/universal/LICENSE.txt
*/

(function () {

    "use strict";

    var fluid = require("infusion"),
        uuid = require("node-uuid"),
        gpii = fluid.registerNamespace("gpii");

    fluid.demands("gpii.requests.request.handler", "userLogin", {
        options: {
            preInitFunction: "gpii.requests.request.handler.userLoginPreInit",
            invokers: {
                handle: {
                    funcName: "gpii.requests.request.handler.userLogin",
                    args: ["{request}", "{gpii.requests.request.handler}"]
                }
            },
            components: {
                request: "{request}",
                preferencesDataSource: "{preferencesDataSource}",
                deviceReporterDataSource: "{deviceReporterDataSource}",
                matchMakerDataSource: "{matchMakerDataSource}",
                lifecycleManager: "{lifecycleManager}"
            },
            events: {
                onRequestEnd: "{request}.events.onRequestEnd",
                onUserListener: null,
                onPreferences: null,
                onDevice: null,
                onReadyToMatch: {
                    events: {
                       preferences: "onPreferences",
                       device: "onDevice"
                    },
                    args: ["{arguments}.preferences.0", "{arguments}.device.0"]
                },
                onMatch: null
            },
            listeners: {
                onUserListener: [{
                    listener: "{gpii.requests.request.handler}.getPreferences"
                }, {
                    listener: "{gpii.requests.request.handler}.getDevice"
                }],
                onReadyToMatch: "{gpii.requests.request.handler}.onReadyToMatchHandler",
                onMatch: "{gpii.requests.request.handler}.onMatchHandler",
                onRequestEnd: {
                    listener: "gpii.requests.request.handler.clearUserLogin",
                    args: ["{that}"]  
                }
            }
        }
    });
    // TODO: fix the framework so that it doesn't attempt to clear injected components
    // TODO: fix the framework so that components whose creation is triggered by an invoker call are properly contextualised
    
    gpii.requests.request.handler.clearUserLogin = function (that) {
        fluid.each(that.options.components, function (config, name) {
            delete that[name];
        });
    };

    gpii.requests.request.handler.userLoginPreInit = function (that) {
        that.getPreferences = function (token) {
            that.preferencesDataSource.get({
                token: token
            }, function (preferences) {
                if (preferences && preferences.isError) {
                    return that.request.res.send(preferences, 500);
                }
                fluid.log("Fetched user preferences: ", preferences);
                that.events.onPreferences.fire(preferences);
            });
        };
        that.getDevice = function () {
            that.deviceReporterDataSource.get(undefined, function (device) {
                if (device && device.isError) {
                    return that.request.res.send(device, 500);
                }
                fluid.log("Fetched device reporter data: ", device);
                that.events.onDevice.fire(device);
            });
        };
        that.onReadyToMatchHandler = function (preferences, device) {
            that.matchMakerDataSource.set(undefined, {
                preferences: preferences,
                device: device
            }, function (match) {
                if (match && match.isError) {
                    return that.request.res.send(match, 500);
                }
                fluid.log("Matched preferences and device reporter data: ", match);
                that.events.onMatch.fire(match);
            });
        };
        that.onMatchHandler = function (match) {
            that.lifecycleManager.start({userToken: that.userToken}, match, function (response) {
                if (response && response.isError) {
                    return that.request.res.send(response, 500);
                }
                fluid.log("Lifecycle manager returned: ", response);
                that.request.res.send("User was successfully logged in.", 200);
            });
        };
    };

    gpii.requests.request.handler.userLogin = function (request, handler) {
        var req = request.req,
            token = req.params.token;
        handler.userToken = token;
        handler.events.onUserListener.fire(token);
    };

})();