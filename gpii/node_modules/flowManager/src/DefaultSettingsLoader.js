/*!
 * Default Settings Loader
 *
 * Copyright 2018 OCAD University
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";

var fluid = fluid || require("infusion"),
    gpii = fluid.registerNamespace("gpii"),
    fs = require("fs"),
    path = require("path"),
    JSON5 = require("json5");

fluid.defaults("gpii.defaultSettingsLoader", {
    gradeNames: ["fluid.component"],
    // The path to the file that has all QSS supported settings.
    defaultSettingsInCodeBase: "%gpii-universal/testData/solutions/defaultSettings.json5",
    members: {
        gpiiSettingsDir: "@expand:{settingsDir}.getGpiiSettingsDir()"
        // "defaultSettingsFile" will be set by "onCreate.prepareSettingsFile".
        // It points to the default settings file in the settings directory. GPII should read from this file.
        // defaultSettingsFile: null
    },
    components: {
        settingsDir: {
            type: "gpii.settingsDir"
        }
    },
    listeners: {
        "onCreate.prepareSettingsFile": {
            listener: "fluid.set",
            args: [
                "{that}",
                "defaultSettingsFile",
                "@expand:gpii.defaultSettingsLoader.prepareSettingsFile({that}.options.defaultSettingsInCodeBase,{that}.gpiiSettingsDir)"
            ]
        }
    },
    invokers: {
        get: {
            funcName: "gpii.defaultSettingsLoader.get",
            args: ["{that}.defaultSettingsFile"]
        }
    }
});

/**
 * Copy default settings file from the code base to the setting dir if it hasn't been copied.
 *
 * @param {String} defaultSettingsInCodeBase - The path to the QSS settings file.
 * @param {String} gpiiSettingsDir - GPII settings directory.
 * @return {Object} Sets that.defaultSettingsFile to the path to the default settings file in the settings dir.
 */
gpii.defaultSettingsLoader.prepareSettingsFile = function (defaultSettingsInCodeBase, gpiiSettingsDir) {
    var defaultSettingsInCodeBaseFullPath = fluid.module.resolvePath(defaultSettingsInCodeBase);

    // Return undefined if the default settings file does not exist in the code base
    if (!fs.existsSync(defaultSettingsInCodeBaseFullPath)) {
        return undefined;
    }

    var gpiiSettingsAbsolutePath = fluid.module.resolvePath(gpiiSettingsDir);

    var defaultSettingsFileName = path.basename(defaultSettingsInCodeBaseFullPath);
    var defaultSettingsFile = path.join(gpiiSettingsAbsolutePath, defaultSettingsFileName);

    // Copy the default settings file to the settings dir if it doesn't already in there
    if (!fs.existsSync(defaultSettingsFile)) {
        fs.writeFileSync(defaultSettingsFile, fs.readFileSync(defaultSettingsInCodeBaseFullPath, "utf-8"));
    }

    return defaultSettingsFile;
};

/**
 * Read QSS settings from the file system
 *
 * @param {String} defaultSettingsFile - The path to the default settings file in the settings dir.
 * @return {Object} Default settings.
 */
gpii.defaultSettingsLoader.get = function (defaultSettingsFile) {
    return defaultSettingsFile ? JSON5.parse(fs.readFileSync(defaultSettingsFile, "utf-8")) : undefined;
};
