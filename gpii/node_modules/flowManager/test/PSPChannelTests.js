/**
 * GPII PSP Channel Tests
 *
 * Copyright 2017 Raising the Floor - International
 *
 * The R&D leading to these results received funding from the
 * Department of Education - Grant H421A150005 (GPII-APCP). However,
 * these results do not necessarily represent the policy of the
 * Department of Education, and you should not assume endorsement by the
 * Federal Government.
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/LICENSE.txt
 */

"use strict";

var fluid  = require("infusion"),
    jqUnit = fluid.require("node-jqunit", require, "jqUnit"),
    gpii   = fluid.registerNamespace("gpii");

fluid.require("%gpii-universal");

gpii.loadTestingSupport();

fluid.registerNamespace("gpii.tests.pspChannel");

gpii.tests.pspChannel.payloads = {
    "connectWithNoUsers": {
        "path": [],
        "type": "ADD",
        "value": {
            "gpiiKey": "noUser",
            "activeContextName": "gpii-default",
            "settingControls": {},
            "preferences": {}
        }
    },
    "logoutUser": {
        "path": [],
        "value": null,
        "type": "DELETE"
    },
    "snapset_1a_loggedIn": {
        "path": [],
        "type": "ADD",
        "value": {
            "gpiiKey": "snapset_1a",
            "activeContextName": "gpii-default",
            // TODO: Consolidate this kind of "canned" SR data so that we don't have to change schemas more than once.
            "settingControls": {
                "http://registry\\.gpii\\.net/common/DPIScale": {
                    "value": 1,
                    "schema": {
                        "title": "DPI Scale",
                        "description": "DPI scale factor on default monitor",
                        "type": "integer",
                        "default": 0,
                        "minimum": -2,
                        "maximum": 4
                    },
                    "liveness": "live"
                },
                "http://registry\\.gpii\\.net/common/cursorSize": {
                    "value": 1,
                    "schema": {
                        "title": "Cursor Size",
                        "description": "Cursor size",
                        "type": "number",
                        "default": 0.5,
                        "minimum": 0,
                        "maximum": 1,
                        "multipleOf": 0.1
                    },
                    "liveness": "liveRestart"
                }
            },
            "preferences": {
                "name": "Larger 125%",
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences"
                    }
                }
            }
        }
    },
    "snapset_2c_loggedIn": {
        "path": [],
        "type": "ADD",
        "value": {
            "gpiiKey": "snapset_2c",
            "activeContextName": "gpii-default",
            // TODO: Consolidate this kind of "canned" SR data so that we don't have to change schemas more than once.
            "settingControls": {
                "http://registry\\.gpii\\.net/common/cursorSize": {
                    "value": 1,
                    "schema": {
                        "title": "Cursor Size",
                        "description": "Cursor size",
                        "type": "number",
                        "default": 0.5,
                        "minimum": 0,
                        "maximum": 1,
                        "multipleOf": 0.1
                    },
                    "liveness": "liveRestart"
                },
                "http://registry\\.gpii\\.net/common/DPIScale": {
                    "value": 3,
                    "schema": {
                        "title": "DPI Scale",
                        "description": "DPI scale factor on default monitor",
                        "type": "integer",
                        "default": 0,
                        "minimum": -2,
                        "maximum": 4
                    },
                    "liveness": "live"
                },
                "http://registry\\.gpii\\.net/common/highContrastTheme": {
                    "value": "white-black",
                    "schema": {
                        "title": "High Contrast theme",
                        "description": "High Contrast Theme",
                        "type": "string",
                        "default": "black-white",
                        "enum": [
                            "black-white",
                            "white-black",
                            "yellow-black",
                            "black-yellow"
                        ],
                        "enumLabels": [
                            "Black on White",
                            "White on Black",
                            "Yellow on Black",
                            "Black on Yellow"
                        ]
                    },
                    "liveness": "live"
                }
            },
            "preferences": {
                "name": "Dark & Larger 175%",
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences"
                    }
                }
            }
        }
    },
    "context1_loggedIn": {
        "path": [],
        "type": "ADD",
        "value": {
            "gpiiKey": "context1",
            "activeContextName": "gpii-default",
            // TODO: Consolidate this kind of "canned" SR data so that we don't have to change schemas more than once.
            "settingControls": {
                "http://registry\\.gpii\\.net/common/magnification": {
                    "value": 1.5,
                    "schema": {
                        "title": "Magnification",
                        "description": "Level of magnification",
                        "type": "number",
                        "default": 1,
                        "minimum": 1,
                        "multipleOf": 0.1
                    },
                    "liveness": "live" // these tests use linux, where it's dynamic
                },
                "http://registry\\.gpii\\.net/common/volume": {
                    "value": 0.5,
                    "schema": {
                        "title": "Volume",
                        "description": "General volume of the operating system",
                        "type": "number",
                        "minimum": 0,
                        "maximum": 1
                    },
                    "liveness": "live"
                }
            },
            "preferences": {
                "name": "Multiple Contexts",
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences"
                    },
                    "bright": {
                        "name": "bright"
                    },
                    "noise": {
                        "name": "noise"
                    },
                    "brightandnoise": {
                        "name": "bright and noise"
                    }
                }
            }
        }
    },
    "context1_bright": {
        "path": [],
        "type": "ADD",
        "value": {
            "gpiiKey": "context1",
            "activeContextName": "bright",
            // TODO: Consolidate this kind of "canned" SR data so that we don't have to change schemas more than once.
            "settingControls": {
                "http://registry\\.gpii\\.net/common/magnification": {
                    "value": 2,
                    "schema": {
                        "title": "Magnification",
                        "description": "Level of magnification",
                        "type": "number",
                        "default": 1,
                        "minimum": 1,
                        "multipleOf": 0.1
                    },
                    "liveness": "live" // these tests use linux, where it's dynamic
                }
            },
            "preferences": {
                "name": "Multiple Contexts",
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences"
                    },
                    "bright": {
                        "name": "bright"
                    },
                    "noise": {
                        "name": "noise"
                    },
                    "brightandnoise": {
                        "name": "bright and noise"
                    }
                }
            }
        }
    }
};

gpii.tests.pspChannel.connectionSucceeded = function (data) {
    jqUnit.assertValue("Connection between client and server can be established", data);
};

gpii.tests.pspChannel.checkPayload = function (data, expected) {
    jqUnit.assertDeepEq("Check PSP channel response is as expected", {
        "type": "modelChanged",
        "payload": gpii.tests.pspChannel.payloads[expected]
    }, data);
};

fluid.defaults("gpii.tests.pspChannel.client", {
    gradeNames: "kettle.test.request.ws",
    path: "/pspChannel",
    port: "{configuration}.options.mainServerPort",
    events: {
        connectionSucceeded: null
    },
    listeners: {
        connectionSucceeded: {
            funcName: "gpii.tests.pspChannel.connectionSucceeded",
            args: ["{arguments}.0"]
        }
    }
});

fluid.defaults("gpii.tests.pspChannel.gpiiKeyRequest", {
    gradeNames: "kettle.test.request.http",
    termMap: {
        gpiiKey: "{that}.options.gpiiKeyName"
    }
});

fluid.defaults("gpii.tests.pspChannel.loginRequest", {
    gradeNames: "gpii.tests.pspChannel.gpiiKeyRequest",
    path: "/user/%gpiiKey/login"
});

fluid.defaults("gpii.tests.pspChannel.logoutRequest", {
    gradeNames: "gpii.tests.pspChannel.gpiiKeyRequest",
    path: "/user/%gpiiKey/logout"
});

gpii.tests.pspChannel.testDef = {
    name: "PSP Channel - Basic user login/logout and client connect/disconnect tests",
    expect: 10,
    config: {
        configName: "gpii.config.development.local.mock.windows",
        configPath: "%gpii-universal/gpii/configs/mocks"
    },
    components: {
        clientOne: {
            type: "gpii.tests.pspChannel.client"
        },
        clientTwo: {
            type: "gpii.tests.pspChannel.client"
        },
        loginUser1a: {
            type: "gpii.tests.pspChannel.loginRequest",
            options: {
                gpiiKeyName: "snapset_1a"
            }
        },
        loginUser2c: {
            type: "gpii.tests.pspChannel.loginRequest",
            options: {
                gpiiKeyName: "snapset_2c"
            }
        },
        logoutUser1a: {
            type: "gpii.tests.pspChannel.logoutRequest",
            options: {
                gpiiKeyName: "snapset_1a"
            }
        }
    },
    sequence: [
        {
            func: "{clientOne}.connect"
        },
        {
            event: "{clientOne}.events.onConnect",
            listener: "gpii.tests.pspChannel.connectionSucceeded"
        },
        {
            event: "{clientOne}.events.onReceiveMessage",
            listener: "gpii.tests.pspChannel.checkPayload",
            args: ["{arguments}.0", "connectWithNoUsers"]
        },
        {
            func: "{loginUser1a}.send"
        },
        {
            event: "{clientOne}.events.onReceiveMessage",
            listener: "gpii.tests.pspChannel.checkPayload",
            args: ["{arguments}.0", "logoutUser"]
        },

        {
            event: "{clientOne}.events.onReceiveMessage",
            listener: "gpii.tests.pspChannel.checkPayload",
            args: ["{arguments}.0", "snapset_1a_loggedIn"]
        },
        {
            func: "{clientOne}.disconnect"
        },
        {
            func: "{clientTwo}.connect"
        },
        {
            event: "{clientTwo}.events.onConnect",
            listener: "gpii.tests.pspChannel.connectionSucceeded"
        },
        {
            event: "{clientTwo}.events.onReceiveMessage",
            listener: "gpii.tests.pspChannel.checkPayload",
            args: ["{arguments}.0", "snapset_1a_loggedIn"]
        },
        {
            func: "{logoutUser1a}.send"
        },
        {
            event: "{clientTwo}.events.onReceiveMessage",
            listener: "gpii.tests.pspChannel.checkPayload",
            args: ["{arguments}.0", "logoutUser"]
        },
        {
            event: "{clientTwo}.events.onReceiveMessage",
            listener: "gpii.tests.pspChannel.checkPayload",
            args: ["{arguments}.0", "connectWithNoUsers"]
        },
        {
            func: "{loginUser2c}.send"
        },
        {
            event: "{clientTwo}.events.onReceiveMessage",
            listener: "gpii.tests.pspChannel.checkPayload",
            args: ["{arguments}.0", "logoutUser"]
        },
        {
            event: "{clientTwo}.events.onReceiveMessage",
            listener: "gpii.tests.pspChannel.checkPayload",
            args: ["{arguments}.0", "snapset_2c_loggedIn"]
        }
    ]
};

gpii.tests.pspChannel.sendContextChange = function (client, newContext) {
    client.send({
        type: "ADD",
        path: ["activeContextName"],
        value: newContext
    });
};

gpii.tests.pspChannel.contextTestDef = {
    name: "PSP Channel - Test triggering context changes and receiving updates",
    expect: 5,
    // As per ContextIntegrationTests.js
    gradeNames: [
        "gpii.test.integration.testCaseHolder.linux"
    ],
    config: {
        configName: "gpii.tests.acceptance.linux.builtIn.config",
        configPath: "%gpii-universal/tests/platform/linux/configs"
    },
    components: {
        pspClient: {
            type: "gpii.tests.pspChannel.client"
        },
        loginContextUser: {
            type: "gpii.tests.pspChannel.loginRequest",
            options: {
                gpiiKeyName: "context1"
            }
        }
    },
    sequence: [{
        func: "{pspClient}.connect"
    }, {
        event: "{pspClient}.events.onConnect",
        listener: "gpii.tests.pspChannel.connectionSucceeded"
    }, {
        event: "{pspClient}.events.onReceiveMessage",
        listener: "gpii.tests.pspChannel.checkPayload",
        args: ["{arguments}.0", "connectWithNoUsers"]
    }, {
        func: "{loginContextUser}.send"
    }, {
        event: "{pspClient}.events.onReceiveMessage",
        listener: "gpii.tests.pspChannel.checkPayload",
        args: ["{arguments}.0", "logoutUser"]
    }, {
        event: "{pspClient}.events.onReceiveMessage",
        listener: "gpii.tests.pspChannel.checkPayload",
        args: ["{arguments}.0", "context1_loggedIn"]
    }, {
        funcName: "gpii.tests.pspChannel.sendContextChange",
        args: ["{pspClient}", "bright"]
    }, {
        event: "{pspClient}.events.onReceiveMessage",
        listener: "gpii.tests.pspChannel.checkPayload",
        args: ["{arguments}.0", "context1_bright"]
    }]
};

gpii.test.runCouchTestDefs([
    gpii.tests.pspChannel.testDef,
    gpii.tests.pspChannel.contextTestDef
]);
