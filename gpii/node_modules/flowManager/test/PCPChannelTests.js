/**
 * GPII PCP Channel Tests
 *
 * Copyright 2017 Raising the Floor - International
 *
 * The R&D leading to these results received funding from the
 * Department of Education - Grant H421A150005 (GPII-APCP). However,
 * these results do not necessarily represent the policy of the
 * Department of Education, and you should not assume endorsement by the
 * Federal Government.
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/LICENSE.txt
 */

"use strict";

var fluid = require("infusion"),
    jqUnit = fluid.require("node-jqunit", require, "jqUnit"),
    gpii = fluid.registerNamespace("gpii"),
    kettle = fluid.registerNamespace("kettle");

fluid.require("%universal");

gpii.loadTestingSupport();

fluid.registerNamespace("gpii.tests.pcpChannel");

gpii.tests.pcpChannel.payloads = {
    "connectWithNoUsers": {
        "path": [],
        "type": "ADD"
    },
    "logoutUser": {
        "path": [],
        "value": null,
        "type": "DELETE"
    },
    "snapset_1a_loggedIn": {
        "path": [],
        "type": "ADD",
        "value": {
            "userToken": "snapset_1a",
            "activeContextName": "gpii-default",
            "settingControls": {
                "http://registry\\.gpii\\.net/common/DPIScale": {
                    "value": 1.25,
                    "schema": {
                        "title": "DPI Scale",
                        "description": "DPI scale factor on default monitor",
                        "type": "number",
                        "min": 1,
                        "max": 2,
                        "divisibleBy": 0.25
                    }
                },
                "http://registry\\.gpii\\.net/common/cursorSize": {
                    "value": 1,
                    "schema": {
                        "title": "Cursor Size",
                        "description": "Cursor size",
                        "type": "number",
                        "min": 0,
                        "max": 1,
                        "divisibleBy": 0.1
                    }
                },
                "http://registry\\.gpii\\.net/common/supportTool": {
                    "value": [
                        "dictionary"
                    ],
                    "schema": {
                        "title": "Support Tools",
                        "description": "Whether to enable/disable certain support tools",
                        "type": "array",
                        "enum": [
                            "dictionary"
                        ]
                    }
                }
            },
            "preferences": {
                "name": "Larger 125%",
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences"
                    }
                }
            }
        }
    },
    "snapset_2c_loggedIn": {
        "path": [],
        "type": "ADD",
        "value": {
            "userToken": "snapset_2c",
            "activeContextName": "gpii-default",
            "settingControls": {
                "http://registry\\.gpii\\.net/common/cursorSize": {
                    "value": 1,
                    "schema": {
                        "title": "Cursor Size",
                        "description": "Cursor size",
                        "type": "number",
                        "min": 0,
                        "max": 1,
                        "divisibleBy": 0.1
                    }
                },
                "http://registry\\.gpii\\.net/common/DPIScale": {
                    "value": 1.75,
                    "schema": {
                        "title": "DPI Scale",
                        "description": "DPI scale factor on default monitor",
                        "type": "number",
                        "min": 1,
                        "max": 2,
                        "divisibleBy": 0.25
                    }
                },
                "http://registry\\.gpii\\.net/applications/com\\.microsoft\\.windows\\.highContrast.http://registry\\.gpii\\.net/common/highContrastEnabled": {
                    "value": true,
                    "schema": {
                        "title": "High Contrast",
                        "description": "Whether to enable/disable High Contrast",
                        "type": "boolean"
                    },
                    "solutionName": "Windows High Contrast"
                },
                "http://registry\\.gpii\\.net/applications/com\\.microsoft\\.windows\\.highContrast.http://registry\\.gpii\\.net/common/highContrastTheme": {
                    "value": "white-black",
                    "schema": {
                        "title": "High Contrast theme",
                        "description": "High Contrast Theme",
                        "type": "string",
                        "enum": [
                            "black-white",
                            "white-black",
                            "yellow-black",
                            "black-yellow"
                        ]
                    },
                    "solutionName": "Windows High Contrast"
                },
                "http://registry\\.gpii\\.net/applications/net\\.gpii\\.uioPlus.http://registry\\.gpii\\.net/common/highContrastEnabled": {
                    "value": true,
                    "schema": {
                        "title": "High Contrast",
                        "description": "Whether to enable/disable High Contrast",
                        "type": "boolean"
                    },
                    "solutionName": "UIO+"
                },
                "http://registry\\.gpii\\.net/applications/net\\.gpii\\.uioPlus.http://registry\\.gpii\\.net/common/highContrastTheme": {
                    "value": "white-black",
                    "schema": {
                        "title": "High Contrast theme",
                        "description": "High Contrast Theme",
                        "type": "string",
                        "enum": [
                            "black-white",
                            "white-black",
                            "yellow-black",
                            "black-yellow"
                        ]
                    },
                    "solutionName": "UIO+"
                }
            },
            "preferences": {
                "name": "Dark & Larger 175%",
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences"
                    }
                }
            }
        }
    },
    "context1_loggedIn": {
        "path": [],
        "type": "ADD",
        "value": {
            "userToken": "context1",
            "activeContextName": "gpii-default",
            "settingControls": {
                "http://registry\\.gpii\\.net/common/magnification": {
                    "value": 1.5,
                    "schema": {
                        "title": "Magnification",
                        "description": "Level of magnification",
                        "type": "number",
                        "min": 1,
                        "divisibleBy": 0.1
                    }
                },
                "http://registry\\.gpii\\.net/common/volume": {
                    "value": 0.5,
                    "schema": {
                        "title": "Volume",
                        "description": "General volume of the operating system",
                        "type": "number",
                        "min": 0,
                        "max": 1
                    }
                }
            },
            "preferences": {
                "name": "Multiple Contexts",
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences"
                    },
                    "bright": {
                        "name": "bright"
                    },
                    "noise": {
                        "name": "noise"
                    },
                    "brightandnoise": {
                        "name": "bright and noise"
                    }
                }
            }
        }
    },
    "context1_bright": {
        "path": [],
        "type": "ADD",
        "value": {
            "userToken": "context1",
            "activeContextName": "bright",
            "settingControls": {
                "http://registry\\.gpii\\.net/common/magnification": {
                    "value": 2,
                    "schema": {
                        "title": "Magnification",
                        "description": "Level of magnification",
                        "type": "number",
                        "min": 1,
                        "divisibleBy": 0.1
                    }
                }
            },
            "preferences": {
                "name": "Multiple Contexts",
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences"
                    },
                    "bright": {
                        "name": "bright"
                    },
                    "noise": {
                        "name": "noise"
                    },
                    "brightandnoise": {
                        "name": "bright and noise"
                    }
                }
            }
        }
    }
};

gpii.tests.pcpChannel.connectionSucceeded = function (data) {
    jqUnit.assertValue("Connection between client and server can be established", data);
};

gpii.tests.pcpChannel.checkPayload = function (data, expected) {
    jqUnit.assertDeepEq("Check PCP channel response is as expected", {
        "type": "modelChanged",
        "payload": gpii.tests.pcpChannel.payloads[expected]
    }, data);
};

fluid.defaults("gpii.tests.pcpChannel.client", {
    gradeNames: "kettle.test.request.ws",
    path: "/pcpChannel",
    port: "{configuration}.options.mainServerPort",
    events: {
        connectionSucceeded: null
    },
    listeners: {
        connectionSucceeded: {
            funcName: "gpii.tests.pcpChannel.connectionSucceeded",
            args: ["{arguments}.0"]
        }
    }
});

fluid.defaults("gpii.tests.pcpChannel.tokenRequest", {
    gradeNames: "kettle.test.request.http",
    termMap: {
        userToken: "{that}.options.tokenName"
    }
});

fluid.defaults("gpii.tests.pcpChannel.loginRequest", {
    gradeNames: "gpii.tests.pcpChannel.tokenRequest",
    path: "/user/%userToken/login"
});

fluid.defaults("gpii.tests.pcpChannel.logoutRequest", {
    gradeNames: "gpii.tests.pcpChannel.tokenRequest",
    path: "/user/%userToken/logout"
});

gpii.tests.pcpChannel.testDef = {
    name: "PCP Channel - Basic user login/logout and client connect/disconnect tests",
    expect: 7,
    config: {
        configName: "gpii.config.development.all.local.mock.windows",
        configPath: "%universal/gpii/configs/mocks"
    },
    components: {
        clientOne: {
            type: "gpii.tests.pcpChannel.client"
        },
        clientTwo: {
            type: "gpii.tests.pcpChannel.client"
        },
        loginUser1a: {
            type: "gpii.tests.pcpChannel.loginRequest",
            options: {
                tokenName: "snapset_1a"
            }
        },
        loginUser2c: {
            type: "gpii.tests.pcpChannel.loginRequest",
            options: {
                tokenName: "snapset_2c"
            }
        },
        logoutUser1a: {
            type: "gpii.tests.pcpChannel.logoutRequest",
            options: {
                tokenName: "snapset_1a"
            }
        }
    },
    sequence: [{
        func: "{clientOne}.connect"
    }, {
        event: "{clientOne}.events.onConnect",
        listener: "gpii.tests.pcpChannel.connectionSucceeded"
    }, {
        event: "{clientOne}.events.onReceiveMessage",
        listener: "gpii.tests.pcpChannel.checkPayload",
        args: ["{arguments}.0", "connectWithNoUsers"]
    }, {
        func: "{loginUser1a}.send"
    }, {
        event: "{clientOne}.events.onReceiveMessage",
        listener: "gpii.tests.pcpChannel.checkPayload",
        args: ["{arguments}.0", "snapset_1a_loggedIn"]
    }, {
        func: "{clientOne}.disconnect"
    }, {
        func: "{clientTwo}.connect"
    }, {
        event: "{clientTwo}.events.onConnect",
        listener: "gpii.tests.pcpChannel.connectionSucceeded"
    }, {
        event: "{clientTwo}.events.onReceiveMessage",
        listener: "gpii.tests.pcpChannel.checkPayload",
        args: ["{arguments}.0", "snapset_1a_loggedIn"]
    }, {
        func: "{logoutUser1a}.send"
    }, {
        event: "{clientTwo}.events.onReceiveMessage",
        listener: "gpii.tests.pcpChannel.checkPayload",
        args: ["{arguments}.0", "logoutUser"]
    }, {
        func: "{loginUser2c}.send"
    },  {
        event: "{clientTwo}.events.onReceiveMessage",
        listener: "gpii.tests.pcpChannel.checkPayload",
        args: ["{arguments}.0", "snapset_2c_loggedIn"]
    }]
};

gpii.tests.pcpChannel.sendContextChange = function (client, newContext) {
    client.send({
        type: "ADD",
        path: ["activeContextName"],
        value: newContext
    });
};

gpii.tests.pcpChannel.contextTestDef = {
    name: "PCP Channel - Test triggering context changes and receiving updates",
    expect: 4,
    // As per ContextIntegrationTests.js
    gradeNames: [
        "gpii.test.integration.testCaseHolder.linux"
    ],
    config: {
        configName: "gpii.tests.acceptance.linux.builtIn.config",
        configPath: "%universal/tests/platform/linux/configs"
    },
    components: {
        pcpClient: {
            type: "gpii.tests.pcpChannel.client"
        },
        loginContextUser: {
            type: "gpii.tests.pcpChannel.loginRequest",
            options: {
                tokenName: "context1"
            }
        }
    },
    sequence: [{
        func: "{pcpClient}.connect"
    }, {
        event: "{pcpClient}.events.onConnect",
        listener: "gpii.tests.pcpChannel.connectionSucceeded"
    }, {
        event: "{pcpClient}.events.onReceiveMessage",
        listener: "gpii.tests.pcpChannel.checkPayload",
        args: ["{arguments}.0", "connectWithNoUsers"]
    }, {
        func: "{loginContextUser}.send"
    }, {
        event: "{pcpClient}.events.onReceiveMessage",
        listener: "gpii.tests.pcpChannel.checkPayload",
        args: ["{arguments}.0", "context1_loggedIn"]
    }, {
        funcName: "gpii.tests.pcpChannel.sendContextChange",
        args: ["{pcpClient}", "bright"]
    }, {
        event: "{pcpClient}.events.onReceiveMessage",
        listener: "gpii.tests.pcpChannel.checkPayload",
        args: ["{arguments}.0", "context1_bright"]
    }]
};

kettle.test.bootstrapServer([
    gpii.tests.pcpChannel.testDef,
    gpii.tests.pcpChannel.contextTestDef
]);
