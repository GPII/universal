/*!
 * GPII Settings Transformer Tests
 *
 * Copyright 2012 OCAD University
 * Copyright 2013-2014 Raising the Floor
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * The research leading to these results has received funding from the European Union's
 * Seventh Framework Programme (FP7/2007-2013)
 * under grant agreement no. 289016.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

/*global jqUnit */

"use strict";

var fluid = fluid || require("infusion"),
    gpii = fluid.registerNamespace("gpii");

(function () {
    fluid.registerNamespace("gpii.tests.contextManager.utils");

    /* --------------- gpii.contextManager.utils.findActiveContexts tests -------------- */
    var findActiveContextsTests = {
        matchData: {
            "inferredConfiguration": {
                "gpii-default": {
                    "applications": {
                        "mac.test": {
                            "active": true,
                            "settings": {
                                "http://registry.gpii.net/common/fontSize": 12
                            }
                        }
                    }
                },
                "all-bright": {
                    "applications": {
                        "mac.test": {
                            "active": true,
                            "settings": {
                                "http://registry.gpii.net/common/fontSize": 13
                            }
                        }
                    },
                    "conditions": [
                        {
                            "type": "http://registry.gpii.net/conditions/inRange",
                            "min": 700,
                            "max": 1000,
                            "inputPath": "http://registry\\.gpii\\.net/common/environment/illuminance"
                        }
                    ]
                },
                "really-bright": {
                    "applications": {
                        "mac.test": {
                            "active": true,
                            "settings": {
                                "http://registry.gpii.net/common/fontSize": 14
                            }
                        }
                    },
                    "conditions": [
                        {
                            "type": "http://registry.gpii.net/conditions/inRange",
                            "min": 900,
                            "inputPath": "http://registry\\.gpii\\.net/common/environment/illuminance"
                        }
                    ]
                },
                "multi-condition": {
                    "applications": {
                        "mac.test": {
                            "active": true,
                            "settings": {
                                "http://registry.gpii.net/common/fontSize": 100
                            }
                        }
                    },
                    "conditions": [
                        {
                            "type": "http://registry.gpii.net/conditions/inRange",
                            "min": 10,
                            "inputPath": "http://registry\\.gpii\\.net/common/environment/auditory\\.noise"
                        }, {
                            "type": "http://registry.gpii.net/conditions/inRange",
                            "max": 20,
                            "inputPath": "http://registry\\.gpii\\.net/common/environment/auditory\\.noise"
                        }
                    ]
                },
                "multi-condition2": {
                    "applications": {
                        "mac.test": {
                            "active": true,
                            "settings": {
                                "http://registry.gpii.net/common/fontSize": 100
                            }
                        }
                    },
                    "conditions": [
                        {
                            "type": "http://registry.gpii.net/conditions/inRange",
                            "min": 10,
                            "inputPath": "http://registry\\.gpii\\.net/common/environment/illuminance"
                        }, {
                            "type": "http://registry.gpii.net/conditions/inRange",
                            "min": 10,
                            "inputPath": "http://registry\\.gpii\\.net/common/environment/auditory\\.noise"
                        }
                    ]
                }
            }
        },
        tests: {
            "No current contexts": {
                currentContexts: {},
                expected: [ "gpii-default" ]
            },
            "Matching single and default": {
                currentContexts: {
                    "http://registry.gpii.net/common/environment/illuminance": 800
                },
                expected: [ "all-bright", "gpii-default" ]
            },
            "Matching two and default": {
                currentContexts: {
                    "http://registry.gpii.net/common/environment/illuminance": 950
                },
                expected: [ "really-bright", "all-bright", "gpii-default" ]
            },
            "multi-condition matching only matching single": {
                currentContexts: {
                    "http://registry.gpii.net/common/environment/auditory.noise": 5
                },
                expected: [ "gpii-default" ]
            },
            "multi-condition matching all criteria in multi-condition": {
                currentContexts: {
                    "http://registry.gpii.net/common/environment/auditory.noise": 15
                },
                expected: [ "multi-condition", "gpii-default" ]
            },
            "multi context matching everything": {
                currentContexts: {
                    "http://registry.gpii.net/common/environment/auditory.noise": 15,
                    "http://registry.gpii.net/common/environment/illuminance": 950
                },
                expected: [ "multi-condition2", "multi-condition", "really-bright", "all-bright", "gpii-default" ]
            }
        }
    };

    jqUnit.test("gpii.contextManager.utils.findActiveContexts test", function () {
        fluid.each(findActiveContextsTests.tests, function (test, testName) {
            var result = gpii.contextManager.utils.findActiveContexts(test.currentContexts, findActiveContextsTests.matchData);
            jqUnit.assertDeepEq("Testing: " + testName, test.expected, result);
        });
    });
})();
