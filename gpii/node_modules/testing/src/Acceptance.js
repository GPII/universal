/**
 * GPII Acceptance Testing
 *
 * Copyright 2013 Raising the Floor International
 * Copyright 2013 OCAD University
 * Copyright 2014 Lucendo Development Ltd.
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * You may obtain a copy of the License at
 * https://github.com/gpii/universal/LICENSE.txt
 *
 */

"use strict";

var fluid = require("infusion"),
    gpii = fluid.registerNamespace("gpii"),
    child_process = require("child_process");
    
// Component which manages execution and observation of an arbitrary process
// By default, will make 6 attempts spaced by 500ms to execute it with the expected output
fluid.defaults("gpii.test.acceptance.exec", {
    gradeNames: ["gpii.test.common.exec", "autoInit"],
    invokers: {
        exec: {
            funcName: "gpii.test.acceptance.exec.exec",
            args: ["{that}", "{arguments}.0", "{arguments}.1"]
        }
    },
    timeout: 500,
    maxTimeouts: 6
});

gpii.test.acceptance.exec.exec = function (that, processSpec, expected) {
    var command = processSpec.command,
        timeout = that.options.timeout,
        maxTimeouts = that.options.maxTimeouts;

    fluid.log("Executing: ", command);

    child_process.exec(command, function (err, stdout, stderr) {
        if (stderr) {
            fluid.log("stderr from command \"", command, "\": ", stderr);
        }
        if (stdout.trim() === expected) {
            that.events.onExecExit.fire(true, processSpec);
        } else {
            processSpec.count = processSpec.count || 0;

            if (processSpec.count >= maxTimeouts) {
                that.events.onExecExit.fire(false, processSpec);
                return;
            }

            processSpec.count++;
            setTimeout(function () {
                gpii.test.acceptance.exec.exec(that, processSpec, expected);
            }, timeout);
        }
    });
};
    
fluid.defaults("gpii.test.acceptance.testCaseHolder", {
    gradeNames: ["gpii.test.common.testCaseHolder", "autoInit"],
    components: {
        exec: {
            type: "gpii.test.acceptance.exec"
        }
    }
});