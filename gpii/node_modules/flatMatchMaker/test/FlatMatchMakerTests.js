/**
/*
* Flat Match Maker
*
* Copyright 2014 Raising the Floor - International
*
* Licensed under the New BSD license. You may not use this file except in
* compliance with this License.
*
* The research leading to these results has received funding from the European Union's
* Seventh Framework Programme (FP7/2007-2013)
* under grant agreement no. 289016.
*
* You may obtain a copy of the License at
* https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

/*global require, module*/
(function () {
    "use strict";

    var fluid = require("infusion"),
        jqUnit = fluid.require("jqUnit"),
        kettle = fluid.registerNamespace("kettle"),
        gpii = fluid.registerNamespace("gpii"),
        $ = fluid.registerNamespace("jQuery");

    fluid.require("flatMatchMaker", require);
    fluid.require("ontologyHandler", require);
    fluid.require("matchMakerFramework", require);
    fluid.require("kettle/test/utils/js/KettleTestUtils", require);

    fluid.registerNamespace("gpii.flatMatchMaker.tests");

    fluid.defaults("gpii.flatMatchMaker.tests", {
        gradeNames: ["fluid.test.testEnvironment", "autoInit"],
        components: {
            tester: {
                type: "gpii.flatMatchMaker.tests.testCaseHolder"
            }
        }
    });

    var inferredCommonfixtures = [
        {
            name: "No existing prefs in original set",
            preferences: {
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {}
                    }
                }
            },
            inferred: {
                "gpii-default": {
                    "org.gnome.desktop.interface": {
                        "http://registry.gpii.net/common/fontSize": 9,
                        "http://registry.gpii.net/common/cursorSize": 0.9
                    },
                    "org.gnome.desktop.a11y.magnifier": {
                        "http://registry.gpii.net/common/magnification": 1.5,
                        "http://registry.gpii.net/common/magnifierPosition": "FullScreen"
                    }
                }
            },
            expect: {
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "http://registry.gpii.net/common/fontSize": 9,
                            "http://registry.gpii.net/common/cursorSize": 0.9,
                            "http://registry.gpii.net/common/magnification": 1.5,
                            "http://registry.gpii.net/common/magnifierPosition": "FullScreen"
                        }
                    }
                }
            }
        }, {
            name: "Existing prefs in original set, some being overwritten",
            preferences: {
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "http://registry.gpii.net/applications/org.gnome.desktop.interface": {
                                "cursor-size": 90,
                                "text-scaling-factor": 0.75
                            },
                            "http://registry.gpii.net/applications/org.alsa-project": {
                                "masterVolume": 50
                            },
                            "http://registry.gpii.net/common/cursorSize": 1
                        }
                    }
                }
            },
            inferred: {
                "gpii-default": {
                    "org.gnome.desktop.interface": {
                        "http://registry.gpii.net/common/fontSize": 9,
                        "http://registry.gpii.net/common/cursorSize": 0.9
                    },
                    "org.gnome.desktop.a11y.magnifier": {
                        "http://registry.gpii.net/common/magnification": 1.5,
                        "http://registry.gpii.net/common/magnifierPosition": "FullScreen"
                    }
                }
            },
            expect: {
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "http://registry.gpii.net/applications/org.gnome.desktop.interface": {
                                "cursor-size": 90,
                                "text-scaling-factor": 0.75
                            },
                            "http://registry.gpii.net/applications/org.alsa-project": {
                                "masterVolume": 50
                            },
                            "http://registry.gpii.net/common/fontSize": 9,
                            "http://registry.gpii.net/common/cursorSize": 1,
                            "http://registry.gpii.net/common/magnification": 1.5,
                            "http://registry.gpii.net/common/magnifierPosition": "FullScreen"
                        }
                    }
                }
            }
        }, {
            name: "Two instances of the same common term present in the inferred common terms",
            preferences: {
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "http://registry.gpii.net/common/cursorSize": 1
                        }
                    }
                }
            },
            inferred: {
                "gpii-default": {
                    "org.gnome.desktop.interface": {
                        "http://registry.gpii.net/common/fontSize": 9,
                        "http://registry.gpii.net/common/cursorSize": 0.9
                    },
                    "org.gnome.desktop.a11y.magnifier": {
                        "http://registry.gpii.net/common/fontSize": 1.5,
                        "http://registry.gpii.net/common/magnifierPosition": "FullScreen"
                    }
                }
            },
            expect: {
                "contexts": {
                    "gpii-default": {
                        "name": "Default preferences",
                        "preferences": {
                            "http://registry.gpii.net/common/fontSize": 9,
                            "http://registry.gpii.net/common/cursorSize": 1,
                            "http://registry.gpii.net/common/magnifierPosition": "FullScreen"
                        }
                    }
                }
            }
        }
    ];

    gpii.flatMatchMaker.tests.addInferredCommon = function() {
        jqUnit.module("flatMatchMaker");
        fluid.each(inferredCommonfixtures, function (fixture) {
            var result = gpii.flatMatchMaker.addInferredCommon(fixture.preferences, fixture.inferred);
            jqUnit.assertDeepEq(fixture.name, fixture.expect, result);
        });
    };

    var disposeStrategyFixtures = [
        {
            description: "Basic test for disposeStrategy function",
            leavesArg: [
                "display.screenEnhancement.fontSize",
                "display.screenEnhancement.magnification",
                "display.screenEnhancement.-provisional-magnifierEnabled",
                "display.screenReader.-provisional-screenReaderTTSEnabled"
            ],
            solRecsArg: {
                "test.dummy": {
                    "solution": {
                        "name": "Test dummy",
                        "contexts": {},
                        "settingsHandlers": [
                            {
                                "type": "gpii.settingsHandlers.JSONSettingsHandler.set",
                                "options": {
                                    "path": "/some/path/to/file.json"
                                },
                                "capabilities": [
                                    "applications.mac\\.dummy.id"
                                ],
                                "capabilitiesTransformations": {
                                    "setting1": "http://registry\\.gpii\\.net/common/fontSize",
                                    "setting2.path1": "http://registry\\.gpii\\.net/common/screenReaderTTSEnabled",
                                    "setting2.path2": "http://registry\\.gpii\\.net/common/magnifierEnabled",
                                    "setting2.path3.hello": "http://registry\\.gpii\\.net/common/magnification"
                                }
                            }
                        ],
                        "lifecycleManager": {}
                    },
                    "skeleton": {
                        "applications": {
                            "test.dummy": {
                                "id": {}
                            }
                        },
                        "display": {
                            "screenEnhancement": {
                                "fontSize": {},
                                "magnification": {},
                                "-provisional-magnifierEnabled": {}
                            },
                            "screenReader": {
                                "-provisional-screenReaderTTSEnabled": {}
                            }
                        }
                    },
                    "index": "test.dummy"
                },
                "test.dummy_2": {
                    "solution": {
                        "name": "Test dummy 2",
                        "contexts": {},
                        "settingsHandlers": [
                            {
                                "type": "gpii.settingsHandlers.noSettings",
                                "capabilities": [
                                    "applications.test\\.dummy_2.id"
                                ]
                            }
                        ],
                        "lifecycleManager": {}
                    },
                    "skeleton": {
                        "applications": {
                            "test.dummy_2": {
                                "id": {}
                            }
                        }
                    },
                    "index": "test.dummy_2"
                }
            },
            expect: {
                "test.dummy_2": {
                    disposition: "reject"
                },
                "test.dummy": {
                    disposition: "accept"
                }
            }
        }
    ];

    gpii.flatMatchMaker.tests.disposeStrategy = function() {
        fluid.each(disposeStrategyFixtures, function (fixture) {
            var result = gpii.flatMatchMaker.disposeStrategy(fixture.leavesArg, fixture.solRecsArg);
            var expected = $.extend(true, {}, fixture.solRecsArg, fixture.expect);

            jqUnit.assertDeepEq(fixture.description, expected, result);
        });
    };

    var matchFixtures = [
        {
            description: "Full match call test",
            input: require("./data/full_mm_payload1.json"),
            expect: {
                "inferredConfiguration": {
                    "gpii-default": {
                        "applications": {
                            "mac.dummy": {
                                "active": true,
                                "settings": {
                                    "http://registry.gpii.net/common/fontSize": 16,
                                    "http://registry.gpii.net/common/screenReaderTTSEnabled": false,
                                    "http://registry.gpii.net/common/magnifierEnabled": false,
                                    "http://registry.gpii.net/common/magnification": 1
                                }
                            }
                        }
                    }
                }
            }
        }
    ];

    gpii.flatMatchMaker.tests.match = function (ontologyHandler) {
        fluid.each(matchFixtures, function (fixture) {
            var result = gpii.flatMatchMaker.match(ontologyHandler, fixture.input, gpii.flatMatchMaker.disposeStrategy);
            jqUnit.assertDeepEq(fixture.description, fixture.expect, result);
        });
    };

    fluid.defaults("gpii.flatMatchMaker.tests.testCaseHolder", {
        gradeNames: ["fluid.test.testCaseHolder", "autoInit"],
        components: {
            "ontologyHandler": {
                type: "gpii.ontologyHandler"
            }
        },
        modules: [{
            name: "flatMatchMakerTests",
            tests: [{
                expect: 3,
                name: "gpii.flatMatchMaker.addInferredCommon tests",
                func: "gpii.flatMatchMaker.tests.addInferredCommon"
            }, {
                expect: 1,
                name: "gpii.flatMatchMaker.disposeStrategy tests",
                func: "gpii.flatMatchMaker.tests.disposeStrategy"
            }, {
                expect: 1,
                name: "gpii.flatMatchMaker.match tests",
                func: "gpii.flatMatchMaker.tests.match",
                args: "{ontologyHandler}"
            }]
        }]
    });

    module.exports = kettle.test.bootstrap("gpii.flatMatchMaker.tests");
})();