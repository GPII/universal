/*!
Rendering Tests

Copyright 2012 Raising the Floor - International

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

You may obtain a copy of the License at
https://github.com/gpii/universal/LICENSE.txt
*/

/*global require, __dirname*/

(function () {
    // This loads universal.
     var fluid = require("infusion"),
         gpii = fluid.registerNamespace("gpii"),
         jqUnit = fluid.require("jqUnit");

    fluid.require("testFramework", require);
    fluid.require("../renderer.js", require);

    var tester = gpii.tests.testEnvironment(),
        template = '<div class="container"><p class="my-paragraph"></p></div>',
        expectedTemplate = '<div class="container"><p class="my-paragraph">TEST</p></div>',
        expectedModelTemplate = '<div class="container"><p class="my-paragraph" id="my-paragraph">TEST</p></div>',
        expectedNewModelTemplate = '<div class="container"><p class="my-paragraph" id="my-paragraph">NEW</p></div>',
        basicTree = {
            children: [{
                ID: "my-paragraph",
                value: "TEST"
            }]
        },
        basicProtoTree = {
            "my-paragraph": "TEST"
        },
        protoTreeModel = {
            "my-paragraph": "${test}"
        },
        basicRendererOptions = {
            autoBind: false,
            cutpoints: [{
                id: "my-paragraph",
                selector: ".my-paragraph"
            }],
            fossils: {},
            document: {
                getElementById: function () {}
            }
        };

    tester.test("Basic rendering", function () {
        var fossils = {};
        var template = '<div class="container"><p class="my-paragraph"></p></div>';
        var options = {
            autoBind: false,
            cutpoints: [{
                id: "my-paragraph",
                selector: ".my-paragraph"
            }],
            fossils: fossils,
            document: {
                getElementById: function () {}
            }
        };
        var resourceSpec = {
            base: {
                resourceText: template,
                href: ".",
                resourceKey: ".",
                cutpoints: options.cutpoints
            }
        };
        var templates = fluid.parseTemplates(resourceSpec, ["base"], options);
        var tree = {
            children: [{
                ID: "my-paragraph",
                value: "TEST"
            }]
        };
        var rendered = fluid.renderTemplates(templates, tree, options, fossils);
        jqUnit.assertEquals("Template is rendered correctly", expectedTemplate, rendered);
    });

    tester.test("gpii.renderer.render", function () {
        var rendered = gpii.renderer.render(template, {
            tree: basicTree,
            rendererOptions: basicRendererOptions
        });
        jqUnit.assertEquals("Template is rendered correctly", expectedTemplate, rendered);
    });

    tester.test("Renderer grade", function () {
        var renderer = gpii.renderer({
            selectors: {
                "my-paragraph": ".my-paragraph"
            },
            protoTree: basicProtoTree
        });
        var rendered = renderer.refreshView(template);
        jqUnit.assertEquals("Template is rendered correctly", expectedTemplate, rendered);
    });

    tester.test("Renderer grade autobind", function () {
        var renderer = gpii.renderer({
            selectors: {
                "my-paragraph": ".my-paragraph"
            },
            model: {
                test: "TEST"
            },
            protoTree: protoTreeModel,
            rendererOptions: {
                autoBind: true
            }
        });
        var rendered = renderer.refreshView(template);
        jqUnit.assertEquals("Template is rendered correctly", expectedModelTemplate, rendered);
        renderer.applier.requestChange("test", "NEW");
        rendered = renderer.refreshView(template);
        jqUnit.assertEquals("Template is rendered correctly", expectedNewModelTemplate, rendered);
    });

}());