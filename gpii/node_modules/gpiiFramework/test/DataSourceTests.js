/*!
XML Settings Handler Tests

Copyright 2012 Raising the Floor - International

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

You may obtain a copy of the License at
https://github.com/gpii/universal/LICENSE.txt
*/

/*global require, __dirname*/

(function () {
    // This loads universal.
     var fluid = require("infusion"),
         gpii = fluid.registerNamespace("gpii"),
         path = require("path"),
         fs = require("fs"),
         jqUnit = fluid.require("jqUnit");

    fluid.require("../dataSource.js", require);
    fluid.require("../../../../tests/gpiiTests.js", require);

    var dataSourceTester = gpii.tests.testEnvironment();

    var cleanUpAndContinue = function (fileName) {
        fileName = fileName.substring(7);
        fs.unlink(fileName);
        jqUnit.start();
    };

    fluid.demands("gpii.urlExpander", "gpii.test", {
        options: {
            vars: {
                root: __dirname
            }
        }
    });

    fluid.demands("gpii.dataSource.errback.handleError", ["gpii.dataSource.errback", "gpii.test"], {
        funcName: "gpii.dataSource.errback.handleErrorTest",
        args: "{arguments}.0"
    });

    gpii.dataSource.errback.handleErrorTest = function (data) {
        jqUnit.assertTrue("Data source should properly handle paths to non-existent files", data.isError);
        jqUnit.start();
    };

    var testConfig = {
        "Testing url datasource with filesystem": {
            dataSourceOptions: {
                url: "file://%root/data/dataSourceTestFile.json"
            },
            testType: "asyncTest",
            operation: "get",
            directModel: null,
            testCases: {
                "Data source should properly fetch data from a local file": {
                    operation: "assertDeepEq",
                    expected: {
                        dataSource: "works"
                    },
                    getTestValue: function (options) {
                        return options.data;
                    }
                }
            }
        },
        "Testing url datasource with filesystem with expansion and no file": {
            dataSourceOptions: {
                url: "file://%root/data/%expand.json",
                termMap: {
                    expand: "%expand"
                }
            },
            testType: "asyncTest",
            operation: "get",
            directModel: {
                expand: "not_found"
            }
        },
        "Testing url datasource with filesystem with expansion and static termMap": {
            dataSourceOptions: {
                url: "file://%root/data/%expand.json",
                termMap: {
                    expand: "dataSourceTestFile"
                }
            },
            testType: "asyncTest",
            operation: "get",
            directModel: null,
            testCases: {
                "Data source should properly fetch data from a local file": {
                    operation: "assertDeepEq",
                    expected: {
                        dataSource: "works"
                    },
                    getTestValue: function (options) {
                        return options.data;
                    }
                }
            }
        },
        "Testing url datasource with filesystem and expansion": {
            dataSourceOptions: {
                url: "file://%root/data/%expand.json",
                termMap: {
                    expand: "%expand"
                }
            },
            testType: "asyncTest",
            operation: "get",
            directModel: {
                expand: "dataSourceTestFile"
            },
            testCases: {
                "Data source should properly fetch data from a local file": {
                    operation: "assertDeepEq",
                    expected: {
                        dataSource: "works"
                    },
                    getTestValue: function (options) {
                        return options.data;
                    }
                }
            }
        },
        "Testing url datasource with filesystem - set": {
            dataSourceOptions: {
                url: "file://%root/data/test.json",
                writable: true
            },
            testType: "asyncTest",
            operation: "set",
            directModel: null,
            model: {
                test: "test"
            },
            testCases: {
                "Data source should properly save data to a local file": {
                    operation: "assertDeepEq",
                    expected: {
                        test: "test"
                    },
                    getTestValue: function (options) {
                        var path = options.dataSource.urlResolver.resolve(options.directModel).substring(7);
                        return JSON.parse(fs.readFileSync(path, "utf8"));
                    }
                }
            }
        },
        "Testing url datasource with filesystem and expansion- set": {
            dataSourceOptions: {
                url: "file://%root/data/%expand.json",
                termMap: {
                    expand: "%expand"
                },
                writable: true
            },
            testType: "asyncTest",
            operation: "set",
            directModel: {
                expand: "test"
            },
            model: {
                test: "test"
            },
            testCases: {
                "Data source should properly save data to a local file": {
                    operation: "assertDeepEq",
                    expected: {
                        test: "test"
                    },
                    getTestValue: function (options) {
                        var path = options.dataSource.urlResolver.resolve(options.directModel).substring(7);
                        return JSON.parse(fs.readFileSync(path, "utf8"));
                    }
                }
            }
        },
        "Initialization": {
            testType: "test",
            testCases: {
                "Data source is initialized": {
                    operation: "assertValue",
                    getTestValue: function (options) {
                        return options.dataSource;
                    }
                },
                "Data source should have a get method": {
                    operation: "assertValue",
                    getTestValue: function (options) {
                        return options.dataSource.get;
                    }
                },
                "Data source should not have a set method by default": {
                    operation: "assertUndefined",
                    getTestValue: function (options) {
                        return options.dataSource.set;
                    }
                }
            }
        },
        "UrlResolver tests: dynamic expansion": {
            testType: "test",
            dataSourceOptions: {
                url: "file://%expand/test.json",
                termMap: {
                    expand: "%expand"
                }
            },
            testCases: {
                "Data source should should expand urls based on termMap": {
                    operation: "assertEquals",
                    expected: "file://test/test.json",
                    getTestValue: function (options) {
                        return options.dataSource.urlResolver.resolve({expand: "test"});
                    }
                }
            }
        },
        "UrlResolver tests: static expansion": {
            testType: "test",
            dataSourceOptions: {
                url: "file://%expand/test.json",
                termMap: {
                    expand: "test"
                }
            },
            testCases: {
                "Data source should should expand urls based on termMap": {
                    operation: "assertEquals",
                    expected: "file://test/test.json",
                    getTestValue: function (options) {
                        return options.dataSource.urlResolver.resolve();
                    }
                }
            }
        }
    };

    var testRunner = function (testsConfig) {
        fluid.each(testsConfig, function (config, testName) {
            dataSourceTester[config.testType](testName, function () {
                var dataSource = gpii.dataSource.URL(config.dataSourceOptions),
                    basicCallback = function (data) {
                        fluid.each(config.testCases, function (testCase, name) {
                            var args = [name], options = {
                                dataSource: dataSource,
                                data: data,
                                directModel: config.directModel
                            };
                            if (testCase.expected) {
                                args.push(testCase.expected);
                            }
                            args.push(testCase.getTestValue(options));
                            jqUnit[testCase.operation].apply(null, args);
                        });
                    }, callback, args = [];
                if (config.testType === "test") {
                    basicCallback();
                    return;
                }
                callback = function (data) {
                    basicCallback(data);
                    if (config.operation === "get") {
                        jqUnit.start();
                        return;
                    }
                    cleanUpAndContinue(dataSource.urlResolver.resolve(config.directModel));
                };
                args.push(config.directModel);
                if (config.model) {
                    args.push(config.model);
                }
                args.push(callback);
                dataSource[config.operation].apply(null, args);
            });
        });
    };

    testRunner(testConfig);

}());